<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¡×™×›×•× ×ª×™×§ ×”×©×§×¢×•×ª ×œ×§×•×—</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0d1b2e;
    --navy-mid: #152540;
    --navy-light: #1e3355;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --silver: #a8b5c4;
    --white: #f4f6fa;
    --green: #2ecc71;
    --red: #e74c3c;
    --orange: #f39c12;
    --text-muted: #8899aa;
    --border: rgba(201,168,76,0.25);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Heebo', sans-serif;
    background: #eef1f6;
    color: var(--navy);
    direction: rtl;
  }

  /* ===== APP SHELL ===== */
  .app {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ===== TABS ===== */
  .tabs-bar {
    background: var(--navy);
    display: flex;
    padding: 0 2rem;
    gap: 0.5rem;
    border-bottom: 2px solid var(--gold);
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .app-logo {
    color: var(--gold);
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    padding: 1rem 0;
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .app-logo span { color: var(--white); font-weight: 300; }

  .tab-btn {
    background: none;
    border: none;
    color: var(--silver);
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    padding: 1rem 1.5rem;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    margin-bottom: -2px;
  }
  .tab-btn:hover { color: var(--white); }
  .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); font-weight: 600; }

  .tab-content { display: none; flex: 1; }
  .tab-content.active { display: block; }

  /* ===== FORM ===== */
  .form-page {
    max-width: 1056px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  .form-header {
    text-align: center;
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #d0d7e3;
  }

  .form-header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 0.3rem;
  }
  .form-header p { color: var(--text-muted); font-size: 0.9rem; }

  .section-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid #e2e8f0;
  }

  .section-card h2 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 1.2rem;
    padding-bottom: 0.7rem;
    border-bottom: 2px solid var(--gold);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-icon {
    width: 28px; height: 28px;
    background: var(--navy);
    color: var(--gold);
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-grid.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
  .form-grid.cols-5 { grid-template-columns: 1fr 0.85fr 1fr 0.85fr 1fr; }
  .form-grid.cols-1 { grid-column: 1fr; }

  .field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .field.full { grid-column: 1 / -1; }

  label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #4a5568;
    letter-spacing: 0.02em;
  }

  input, select, textarea {
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    padding: 0.55rem 0.8rem;
    border: 1.5px solid #d1dae6;
    border-radius: 8px;
    background: #f8fafc;
    color: var(--navy);
    transition: border-color 0.2s, box-shadow 0.2s;
    direction: rtl;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(201,168,76,0.12);
    background: white;
  }

  textarea { resize: vertical; min-height: 70px; }

  .toggle-section {
    background: #f0f4fa;
    border-radius: 8px;
    padding: 0.8rem 1rem;
    margin-bottom: 0.8rem;
  }

  .toggle-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
  }

  .toggle-header label { cursor: pointer; font-size: 0.9rem; font-weight: 600; }

  .toggle-body { display: none; margin-top: 1rem; }
  .toggle-body.open { display: block; }

  /* Savings blocks */
  .savings-list { display: flex; flex-direction: column; gap: 1rem; }

  .saving-block {
    background: #f8fafc;
    border: 1.5px solid #e2e8f0;
    border-radius: 10px;
    padding: 1rem;
    position: relative;
  }

  .saving-block-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.8rem;
  }

  .saving-block-title {
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--navy);
    background: var(--navy);
    color: var(--gold);
    padding: 0.2rem 0.7rem;
    border-radius: 20px;
  }

  .btn-remove {
    background: none;
    border: 1.5px solid #e74c3c;
    color: #e74c3c;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 0.75rem;
    transition: all 0.2s;
  }
  .btn-remove:hover { background: #e74c3c; color: white; }

  .btn-add {
    background: none;
    border: 2px dashed var(--gold);
    color: var(--gold);
    padding: 0.7rem 1.5rem;
    border-radius: 10px;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    width: 100%;
    transition: all 0.2s;
    margin-top: 0.5rem;
  }
  .btn-add:hover { background: rgba(201,168,76,0.08); }

  .csv-actions {
    display: flex;
    gap: 0.8rem;
    justify-content: center;
    margin-top: 0.8rem;
  }

  .btn-csv-export, .btn-csv-import {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.55rem 1.4rem;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    font-family: inherit;
  }

  .btn-csv-export {
    background: #27ae60;
    color: #fff;
  }

  .btn-csv-export:hover { background: #219a52; transform: translateY(-1px); }

  .btn-csv-import {
    background: #2980b9;
    color: #fff;
  }

  .btn-csv-import:hover { background: #2471a3; transform: translateY(-1px); }

  /* Compact summary table */
  .compact-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
    direction: rtl;
    margin-bottom: 0.5rem;
  }

  .compact-table thead tr { background: var(--navy); }

  .compact-table thead th {
    color: var(--gold);
    font-weight: 600;
    padding: 0.55rem 0.7rem;
    text-align: right;
    font-size: 0.72rem;
    letter-spacing: 0.03em;
    white-space: nowrap;
  }

  .compact-table tbody tr:nth-child(even) { background: #f7fafd; }
  .compact-table tbody tr:hover { background: #eef4fb; }
  .compact-table tbody tr { border-bottom: 1px solid #e8edf5; }

  .compact-table tbody td {
    padding: 0.5rem 0.7rem;
    color: var(--navy);
    vertical-align: middle;
    white-space: nowrap;
  }

  .compact-table .loan-flag {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    background: #fff0ec;
    color: #c0392b;
    border-radius: 4px;
    padding: 0.1rem 0.4rem;
    font-size: 0.68rem;
    font-weight: 700;
  }

  @media print {
    .csv-actions { display: none !important; }
    .compact-table { font-size: 7pt !important; }
    .compact-table thead th { padding: 3pt 5pt !important; font-size: 6.5pt !important; }
    .compact-table tbody td { padding: 3pt 5pt !important; }
  }

  .btn-generate {
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
    color: var(--navy);
    border: none;
    padding: 1rem 3rem;
    border-radius: 50px;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    display: block;
    margin: 2rem auto 0;
    transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(201,168,76,0.35);
    letter-spacing: 0.03em;
  }
  .btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(201,168,76,0.45);
  }

  /* ===== REPORT ===== */
  #report-container {
    padding: 2rem 1rem;
    min-height: 100vh;
    background: #eef1f6;
  }

  .report-empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
  }
  .report-empty svg { margin-bottom: 1rem; opacity: 0.3; }

  /* REPORT STYLES */
  .report {
    max-width: 1170px;
    margin: 0 auto;
    font-family: 'Heebo', sans-serif;
    direction: rtl;
  }

  /* Report Header */
  .report-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    border-radius: 16px 16px 0 0;
    padding: 2.5rem 2.5rem 2rem;
    position: relative;
    overflow: hidden;
  }

  .report-header::before {
    content: '';
    position: absolute;
    top: -50px; left: -50px;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: rgba(201,168,76,0.08);
  }

  .report-header::after {
    content: '';
    position: absolute;
    bottom: -80px; left: 100px;
    width: 300px; height: 300px;
    border-radius: 50%;
    background: rgba(201,168,76,0.05);
  }

  .report-header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
    z-index: 1;
  }

  .report-client-info h1 {
    font-size: 2rem;
    font-weight: 800;
    color: white;
    line-height: 1.2;
    margin-bottom: 0.3rem;
  }

  .report-client-id {
    color: var(--gold);
    font-size: 0.85rem;
    font-weight: 500;
    letter-spacing: 0.05em;
  }

  .report-date-badge {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-align: center;
  }
  .report-date-badge .date-label { color: var(--silver); font-size: 0.7rem; margin-bottom: 0.2rem; }
  .report-date-badge .date-value { color: white; font-size: 0.9rem; font-weight: 600; }

  /* Summary banner */
  .summary-banner {
    background: var(--navy-mid);
    padding: 1.5rem 2.5rem;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0;
    border-bottom: 2px solid var(--gold);
  }

  .summary-stat {
    padding: 0 1.5rem;
    border-left: 1px solid rgba(255,255,255,0.08);
  }
  .summary-stat:last-child { border-left: none; }
  .summary-stat:first-child { padding-right: 0; }

  .stat-label {
    color: var(--silver);
    font-size: 0.72rem;
    font-weight: 500;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    margin-bottom: 0.35rem;
  }

  .stat-value {
    color: var(--gold);
    font-size: 1.4rem;
    font-weight: 700;
    line-height: 1;
  }

  .stat-sub {
    color: #6b7e8f;
    font-size: 0.72rem;
    margin-top: 0.2rem;
  }

  /* Report body */
  .report-body {
    background: white;
    padding: 2rem 2.5rem;
    border-radius: 0 0 16px 16px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.12);
  }

  .report-section {
    margin-bottom: 2rem;
  }

  .report-section-title {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--navy);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .report-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #e2e8f0;
  }

  .report-section-title .dot {
    width: 8px; height: 8px;
    background: var(--gold);
    border-radius: 50%;
    flex-shrink: 0;
  }

  /* Savings cards */
  .savings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 1rem;
  }

  .saving-card {
    border: 1.5px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .saving-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }

  .saving-card-header {
    background: var(--navy);
    padding: 0.72rem 0.94rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .saving-card-header .company { color: var(--gold); font-weight: 700; font-size: 0.81rem; }
  .saving-card-header .policy { color: var(--silver); font-size: 0.64rem; }

  .saving-card-status {
    padding: 0.17rem 0.64rem;
    border-radius: 20px;
    font-size: 0.61rem;
    font-weight: 600;
  }

  .status-active { background: rgba(46,204,113,0.2); color: #27ae60; }
  .status-pending { background: rgba(243,156,18,0.2); color: #e67e22; }
  .status-cancelled { background: rgba(231,76,60,0.2); color: #c0392b; }
  .status-redeemed { background: rgba(108,122,137,0.2); color: #607080; }

  .saving-card-body { padding: 0.85rem 0.94rem; }

  .card-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.38rem 0;
    border-bottom: 1px solid #f0f4fa;
  }
  .card-row:last-child { border-bottom: none; }

  .card-row .key {
    font-size: 0.66rem;
    color: #6b7e8f;
    font-weight: 500;
  }

  .card-row .val {
    font-size: 0.70rem;
    color: var(--navy);
    font-weight: 600;
    text-align: left;
  }

  .liquidity-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.64rem;
    font-weight: 600;
    padding: 0.13rem 0.51rem;
    border-radius: 12px;
  }

  .liquid { background: rgba(46,204,113,0.15); color: #27ae60; }
  .not-liquid { background: rgba(231,76,60,0.12); color: #c0392b; }

  /* Loan rows */
  .loan-block {
    background: #fff8ec;
    border: 1.5px solid #f5dfa0;
    border-radius: 10px;
    padding: 0.9rem 1.1rem;
    margin-top: 0.6rem;
  }

  .loan-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #b7760d;
    margin-bottom: 0.6rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .loan-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem 1rem;
  }

  .loan-item .k { font-size: 0.7rem; color: #9a7235; }
  .loan-item .v { font-size: 0.82rem; font-weight: 600; color: #6b4c12; }

  /* Bottom summary */
  /* ===== COMPACT FINANCIAL SUMMARY BAR ===== */
  .fin-summary-bar {
    display: flex;
    align-items: center;
    gap: 0;
    background: linear-gradient(90deg, var(--navy) 0%, var(--navy-mid) 100%);
    border-radius: 10px;
    padding: 0.55rem 1.1rem;
    margin-top: 0.6rem;
    flex-wrap: wrap;
    gap: 0.2rem 0;
  }
  .fsb-item {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.9rem;
    font-size: 0.78rem;
    color: var(--silver);
    white-space: nowrap;
  }
  .fsb-item strong { color: #fff; font-weight: 800; }
  .fsb-item .fsb-amt { color: var(--gold-light); font-weight: 700; }
  .fsb-sep { width: 1px; height: 1.6rem; background: rgba(255,255,255,0.12); flex-shrink: 0; }

  /* Legacy â€” keep for print @media overrides */
  .bottom-summary { display: none; }
  .bottom-stat { display: none; }

  .report-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .footer-note { font-size: 0.72rem; color: #aab5c5; }
  .agent-sig { font-size: 0.82rem; font-weight: 600; color: var(--navy); }

  /* ===== PRINT - MATCHES SCREEN EXACTLY ===== */
  @media print {
    @page {
      size: A4 landscape;
      margin: 8mm 10mm;
    }

    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

    body { background: white !important; font-size: 9pt; }

    .tabs-bar, .btn-print, #tab-form-content { display: none !important; }
    .tab-content { display: block !important; }

    #report-container {
      background: white !important;
      padding: 0 !important;
    }

    /* Report wrapper - full width */
    .report { max-width: 100% !important; margin: 0 !important; }

    /* Header */
    .report-header {
      border-radius: 4pt 4pt 0 0 !important;
      padding: 10pt 12pt 8pt !important;
      break-after: avoid !important;
    }
    .report-header h1 { font-size: 16pt !important; }
    .report-client-id { font-size: 8pt !important; }
    .date-label { font-size: 6.5pt !important; }
    .date-value { font-size: 10pt !important; }

    /* Summary banner */
    .summary-banner { padding: 6pt 12pt !important; break-before: avoid !important; break-after: avoid !important; }
    .stat-label { font-size: 6.5pt !important; }
    .stat-value { font-size: 13pt !important; }
    .stat-sub { font-size: 6pt !important; }

    /* Report body */
    .report-body {
      padding: 8pt 10pt !important;
      box-shadow: none !important;
      border-radius: 0 0 4pt 4pt !important;
      break-before: avoid !important;
    }

    .report-section { margin-bottom: 8pt !important; }
    .report-section-title { margin-bottom: 5pt !important; font-size: 7.5pt !important; break-after: avoid !important; }

    /* Cards grid - dynamic columns in landscape, respect data-cols attribute */
    .cards-grid {
      display: grid !important;
      gap: 4pt !important;
      margin-top: 3pt !important;
      break-before: avoid !important;
      break-inside: auto !important;
    }
    .cards-grid[data-cols="2"] { grid-template-columns: repeat(2, 1fr) !important; }
    .cards-grid[data-cols="3"] { grid-template-columns: repeat(3, 1fr) !important; }
    .cards-grid[data-cols="4"] { grid-template-columns: repeat(4, 1fr) !important; }

    /* First report section (cards section) - no break before, keep with banner */
    .report-body { break-inside: auto !important; }
    .report-section:first-child { break-before: avoid !important; }
    .saving-card { break-inside: avoid !important; border: 1pt solid #dde3ec !important; }

    /* Compact table - full width, same as screen */
    .compact-table { font-size: 7pt !important; width: 100% !important; table-layout: fixed !important; }
    .compact-table thead th { padding: 3pt 4pt !important; font-size: 6.5pt !important; }
    .compact-table tbody td { padding: 3pt 4pt !important; font-size: 7pt !important; }
    .compact-table tfoot td { padding: 3pt 4pt !important; font-size: 7pt !important; }

    /* Liquidity badges in table */
    .liquidity-badge { font-size: 6pt !important; padding: 1pt 3pt !important; }

    /* Bottom summary */
    .bottom-summary {
      margin-top: 6pt !important;
      padding: 7pt 10pt !important;
      break-inside: avoid !important;
    }
    .bs-label { font-size: 6.5pt !important; }
    .bs-value { font-size: 13pt !important; }
    .bs-sub { font-size: 6pt !important; }

    /* Loans detail table */
    .loans-table { font-size: 7pt !important; }
    .loans-table thead th { padding: 3pt 4pt !important; font-size: 6.5pt !important; }
    .loans-table tbody td { padding: 3pt 4pt !important; }

    /* PAGE BREAKS - 3 page PDF structure */
    .table-page-start { break-before: page !important; margin-top: 0 !important; }
    .planning-page { break-before: page !important; margin-top: 0 !important; overflow: visible !important; }

    /* Footer */
    .report-footer { margin-top: 5pt !important; padding-top: 5pt !important; break-before: avoid !important; }
    .footer-note { font-size: 6pt !important; }
    .agent-sig { font-size: 7pt !important; }

    /* Saving card status badges */
    .saving-card-status { font-size: 5.5pt !important; padding: 1pt 3pt !important; }
  }

  /* ===== RECOMMENDATION BLOCK ===== */
  .rec-form-block {
    margin-top: 0.8rem;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .rec-form-header {
    background: linear-gradient(90deg, #1a2e4a, #1e3a58);
    padding: 0.55rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 0.04em;
  }
  .rec-form-body {
    background: #f8fbff;
    padding: 0.9rem 1rem;
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 0.75rem;
  }
  .rec-type-select {
    font-family: 'Heebo', sans-serif;
    font-size: 0.83rem;
    padding: 0.45rem 0.7rem;
    border: 1.5px solid #d0dbe8;
    border-radius: 7px;
    background: white;
    color: var(--navy);
    width: 100%;
    cursor: pointer;
  }
  .rec-priority-group {
    display: flex;
    gap: 0.4rem;
    align-items: center;
  }
  .rec-priority-btn {
    padding: 0.35rem 0.7rem;
    border-radius: 20px;
    border: 1.5px solid #ddd;
    background: white;
    cursor: pointer;
    font-size: 0.72rem;
    font-weight: 600;
    transition: all 0.15s;
  }
  .rec-priority-btn.high.active   { background: #fff0f0; border-color: #e74c3c; color: #c0392b; }
  .rec-priority-btn.mid.active    { background: #fffbf0; border-color: #f39c12; color: #b7760d; }
  .rec-priority-btn.low.active    { background: #f0fff4; border-color: #27ae60; color: #1e8449; }
  .rec-form-notes {
    grid-column: 1 / -1;
  }
  .rec-form-notes textarea {
    width: 100%;
    font-family: 'Heebo', sans-serif;
    font-size: 0.82rem;
    padding: 0.5rem 0.7rem;
    border: 1.5px solid #d0dbe8;
    border-radius: 7px;
    resize: none;
    height: 52px;
    color: var(--navy);
  }

  /* Recommendation in report card */
  .rec-card-block {
    border-top: 1.5px solid #e8eef5;
    margin-top: 0.5rem;
    padding-top: 0.6rem;
  }
  .rec-card-block.high { border-top-color: #e74c3c; }
  .rec-card-block.mid  { border-top-color: #f39c12; }
  .rec-card-block.low  { border-top-color: #27ae60; }

  .rec-card-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-size: 0.68rem;
    font-weight: 700;
    margin-bottom: 0.35rem;
  }
  .rec-card-pill.high { background: #fff0f0; color: #c0392b; border: 1px solid #e74c3c; }
  .rec-card-pill.mid  { background: #fffbf0; color: #b7760d; border: 1px solid #f39c12; }
  .rec-card-pill.low  { background: #f0fff4; color: #1e8449; border: 1px solid #27ae60; }
  .rec-card-pill.none { background: #f4f6fa; color: #8899aa; border: 1px solid #dde3ec; }

  .rec-card-text {
    font-size: 0.75rem;
    color: #445566;
    line-height: 1.4;
    margin-bottom: 0.25rem;
  }
  .rec-card-date {
    font-size: 0.67rem;
    color: #8899aa;
  }

  /* Planning page */
  .planning-page {
    margin-top: 2rem;
    border: 2px solid var(--gold);
    border-radius: 14px;
    overflow: hidden;
    break-before: auto;
  }
  .planning-header {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .planning-header h3 {
    color: var(--gold);
    font-size: 1.1rem;
    font-weight: 700;
  }
  .planning-header .ph-sub {
    color: var(--silver);
    font-size: 0.78rem;
    margin-top: 0.15rem;
  }
  .planning-header .ph-stats {
    display: flex;
    gap: 1rem;
  }
  .planning-header .ph-stat {
    text-align: center;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    padding: 0.4rem 0.8rem;
  }
  .planning-header .ph-stat .n {
    font-size: 1.3rem;
    font-weight: 800;
    color: white;
    line-height: 1;
  }
  .planning-header .ph-stat .l {
    font-size: 0.65rem;
    color: var(--silver);
    margin-top: 0.1rem;
  }
  .planning-body { padding: 1.2rem 1.5rem; background: white; }
  .planning-group { margin-bottom: 1.2rem; }
  .planning-group-title {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 0.6rem;
    padding-bottom: 0.4rem;
    border-bottom: 2px solid;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .planning-group-title.high { color: #c0392b; border-color: #e74c3c; }
  .planning-group-title.mid  { color: #b7760d; border-color: #f39c12; }
  .planning-group-title.low  { color: #1e8449; border-color: #27ae60; }
  .planning-group-title.done { color: #8899aa; border-color: #dde3ec; }

  .planning-row {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0.8rem;
    align-items: start;
    padding: 0.55rem 0.7rem;
    border-radius: 8px;
    margin-bottom: 0.4rem;
    background: #f9fbfd;
    border: 1px solid #e8eef5;
  }
  .planning-row.high { background: #fff8f8; border-color: #fdd; }
  .planning-row.mid  { background: #fffdf5; border-color: #fde8a0; }
  .planning-row.low  { background: #f5fff8; border-color: #c8ead2; }

  .pr-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 800;
    color: white;
    flex-shrink: 0;
    margin-top: 0.1rem;
  }
  .pr-num.high { background: #e74c3c; }
  .pr-num.mid  { background: #f39c12; }
  .pr-num.low  { background: #27ae60; }

  .pr-content .pr-action {
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--navy);
  }
  .pr-content .pr-who {
    font-size: 0.72rem;
    color: #8899aa;
    margin-top: 0.1rem;
  }
  .pr-content .pr-note {
    font-size: 0.75rem;
    color: #556677;
    margin-top: 0.25rem;
    font-style: italic;
  }
  .pr-date {
    font-size: 0.7rem;
    color: #8899aa;
    white-space: nowrap;
    text-align: left;
  }
  .pr-date.urgent { color: #e74c3c; font-weight: 700; }

  .planning-no-action {
    font-size: 0.78rem;
    color: #8899aa;
    padding: 0.4rem 0.7rem;
  }

  .btn-print {
    background: var(--navy);
    color: var(--gold);
    border: none;
    padding: 0.7rem 2rem;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Heebo', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 auto 1.5rem;
    transition: all 0.2s;
  }
  .btn-print:hover { background: var(--navy-light); }

  /* Loans Table */
  .loans-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
    direction: rtl;
  }
  .loans-table thead tr { background: var(--navy); }
  .loans-table thead th {
    color: var(--gold);
    font-weight: 600;
    padding: 0.65rem 0.9rem;
    text-align: right;
    font-size: 0.75rem;
    letter-spacing: 0.03em;
    white-space: nowrap;
  }
  .loans-table tbody tr { border-bottom: 1px solid #f0f4fa; }
  .loans-table tbody tr:hover { background: #fafbfd; }
  .loans-table tbody td {
    padding: 0.7rem 0.9rem;
    color: var(--navy);
    vertical-align: middle;
  }
  .loans-total-row {
    background: #fff8ec !important;
    border-top: 2px solid #f5dfa0 !important;
    border-bottom: none !important;
  }
  .loans-total-row td { padding: 0.75rem 0.9rem !important; }

  .yield-display {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    height: 40px;
    padding: 0 0.8rem;
    border-radius: 8px;
    border: 1px solid #e0e8f0;
    background: #f8fafd;
    overflow: hidden;
  }

  .yield-value {
    font-size: 1.1rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: #aaa;
    white-space: nowrap;
  }

  .yield-value.positive { color: #27ae60; }
  .yield-value.negative { color: #e74c3c; }
  .yield-value.neutral { color: #f39c12; }

  .yield-gain {
    font-size: 0.65rem;
    color: #8899aa;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .goal-chip {
    display: inline-flex;
    align-items: center;
    background: rgba(13,27,46,0.07);
    color: var(--navy);
    border-radius: 20px;
    padding: 0.15rem 0.7rem;
    font-size: 0.78rem;
    font-weight: 600;
  }

  .owner-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: rgba(201,168,76,0.12);
    color: #8a6a1a;
    border-radius: 6px;
    padding: 0.2rem 0.6rem;
    font-size: 0.78rem;
    font-weight: 600;
    margin-top: 0.4rem;
  }

  /* ===== MISLAKA IMPORT SECTION ===== */
  .mislaka-section {
    margin-top: 2rem;
    border: 2px dashed var(--gold);
    border-radius: 14px;
    padding: 1.5rem 1.8rem;
    background: linear-gradient(135deg, rgba(201,168,76,0.05) 0%, rgba(13,27,46,0.02) 100%);
  }
  .mislaka-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.2rem;
  }
  .mislaka-icon-wrap {
    width: 52px;
    height: 52px;
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
    flex-shrink: 0;
    box-shadow: 0 2px 10px rgba(13,27,46,0.2);
  }
  .mislaka-title {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--navy);
  }
  .mislaka-subtitle {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    line-height: 1.4;
  }
  .mislaka-upload-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .btn-mislaka {
    display: inline-flex;
    align-items: center;
    gap: 0.55rem;
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
    color: var(--navy);
    border: none;
    border-radius: 10px;
    padding: 0.75rem 1.5rem;
    font-family: 'Heebo', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 10px rgba(201,168,76,0.35);
    white-space: nowrap;
  }
  .btn-mislaka:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 16px rgba(201,168,76,0.45);
  }
  .mislaka-status-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.87rem;
    color: var(--text-muted);
    min-height: 1.5em;
  }
  .mislaka-status-bar.success { color: var(--green); font-weight: 600; }
  .mislaka-status-bar.error   { color: var(--red);   font-weight: 600; }
  .mislaka-status-bar.loading { color: var(--gold);  font-weight: 600; }

  /* ===== MISLAKA MODAL ===== */
  .mislaka-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(8,18,35,0.72);
    z-index: 9000;
    align-items: center;
    justify-content: center;
    padding: 1.2rem;
    backdrop-filter: blur(3px);
  }
  .mislaka-overlay.open { display: flex; }
  .mislaka-modal {
    background: #fff;
    border-radius: 18px;
    width: 100%;
    max-width: 880px;
    max-height: 88vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 24px 64px rgba(0,0,0,0.38);
  }
  .mislaka-modal-head {
    background: linear-gradient(90deg, var(--navy) 0%, var(--navy-light) 100%);
    padding: 1.1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-shrink: 0;
  }
  .mislaka-modal-head h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--gold-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .mislaka-modal-head .client-chip {
    background: rgba(201,168,76,0.18);
    border: 1px solid rgba(201,168,76,0.4);
    border-radius: 20px;
    padding: 0.25rem 0.8rem;
    font-size: 0.82rem;
    color: var(--gold-light);
    font-weight: 600;
  }
  .btn-modal-close {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--silver);
    font-size: 1.1rem;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .btn-modal-close:hover { background: rgba(255,255,255,0.18); color: #fff; }
  .mislaka-modal-body {
    overflow-y: auto;
    padding: 1.4rem 1.5rem;
    flex: 1;
  }
  .mislaka-client-banner {
    background: linear-gradient(90deg, var(--navy) 0%, var(--navy-mid) 100%);
    border-radius: 10px;
    padding: 0.85rem 1.2rem;
    margin-bottom: 1.3rem;
    display: flex;
    align-items: center;
    gap: 2.5rem;
    flex-wrap: wrap;
  }
  .mislaka-client-banner .bcl { font-size: 0.62rem; color: var(--silver); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.18rem; }
  .mislaka-client-banner .bcv { font-size: 1rem; font-weight: 700; color: var(--gold-light); }
  .mislaka-client-banner .bcv.small { font-size: 0.88rem; color: #c8d6e8; }
  .mislaka-count-badge {
    margin-right: auto;
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.35);
    border-radius: 20px;
    padding: 0.3rem 1rem;
    font-size: 0.82rem;
    color: var(--gold-light);
    font-weight: 700;
  }
  /* Product card in modal */
  .mp-card {
    border: 1.5px solid #dde8f4;
    border-radius: 12px;
    margin-bottom: 1rem;
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .mp-card:hover { box-shadow: 0 4px 16px rgba(13,27,46,0.1); }
  .mp-card-head {
    background: linear-gradient(90deg, var(--navy) 0%, var(--navy-light) 100%);
    padding: 0.7rem 1.1rem;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }
  .mp-card-head .mpc-company { font-size: 0.95rem; font-weight: 700; color: var(--gold-light); }
  .mp-card-head .mpc-plan { font-size: 0.75rem; color: var(--silver); margin-top: 0.18rem; }
  .mp-card-head .mpc-policy { font-size: 0.68rem; color: rgba(168,181,196,0.8); margin-top: 0.12rem; font-family: monospace; }
  .mpc-status {
    font-size: 0.72rem;
    font-weight: 700;
    padding: 0.22rem 0.7rem;
    border-radius: 12px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .mpc-status.active   { background: rgba(46,204,113,0.18); color: #27ae60; border: 1px solid rgba(46,204,113,0.4); }
  .mpc-status.inactive { background: rgba(231,76,60,0.15);  color: #e74c3c; border: 1px solid rgba(231,76,60,0.35); }
  .mpc-status.pending  { background: rgba(243,156,18,0.15); color: #d68910; border: 1px solid rgba(243,156,18,0.35); }
  .mp-card-body { padding: 1rem 1.1rem; }
  .mp-fields {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 0.5rem 1.2rem;
    margin-bottom: 0.8rem;
  }
  .mp-field .mpf-lbl { font-size: 0.65rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.12rem; }
  .mp-field .mpf-val { font-size: 0.88rem; font-weight: 600; color: var(--navy); }
  .mp-field .mpf-val.green { color: #27ae60; font-size: 0.98rem; font-weight: 800; }
  .mp-field .mpf-val.blue  { color: #2980b9; }
  .mp-field .mpf-val.gold  { color: #b7860d; }
  /* Tracks section */
  .mp-tracks { border-top: 1px solid #ecf0f5; padding-top: 0.75rem; margin-top: 0.2rem; }
  .mp-tracks-title { font-size: 0.75rem; font-weight: 700; color: var(--navy); margin-bottom: 0.45rem; }
  .mp-track-row {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: 0.5rem;
    padding: 0.3rem 0.5rem;
    background: #f5f8fc;
    border-radius: 6px;
    margin-bottom: 0.25rem;
    font-size: 0.76rem;
    align-items: center;
  }
  .mp-track-row .tr-name { color: #334455; }
  .mp-track-row .tr-pct  { color: var(--gold); font-weight: 700; text-align: left; min-width: 40px; }
  .mp-track-row .tr-amt  { color: #27ae60; font-weight: 700; text-align: left; min-width: 88px; }
  .mp-track-row .tr-yld  { color: #2980b9; font-weight: 700; text-align: left; min-width: 44px; }
  /* Loan section in modal */
  .mp-loan {
    border-top: 1px solid #ecf0f5;
    padding-top: 0.7rem;
    margin-top: 0.2rem;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
  }
  .mp-loan-title { font-size: 0.78rem; font-weight: 700; color: #c0392b; width: 100%; margin-bottom: 0.1rem; }
  .mp-loan-item { font-size: 0.8rem; }
  .mp-loan-item .k { color: #8899aa; }
  .mp-loan-item .v { font-weight: 700; color: var(--navy); }
  .mp-loan-item .v.red { color: #c0392b; }
  /* Coverages */
  .mp-coverages {
    border-top: 1px solid #ecf0f5;
    padding-top: 0.55rem;
    margin-top: 0.2rem;
    font-size: 0.74rem;
    color: #667788;
    line-height: 1.5;
  }
  .mp-coverages strong { color: var(--navy); }
  /* Modal footer */
  .mislaka-modal-foot {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e8edf4;
    display: flex;
    gap: 0.8rem;
    justify-content: flex-end;
    align-items: center;
    flex-shrink: 0;
    background: #fafbfd;
  }
  .mislaka-modal-foot .foot-note {
    margin-right: auto;
    font-size: 0.78rem;
    color: var(--text-muted);
  }
  .btn-confirm-import {
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
    color: var(--gold-light);
    border: none;
    border-radius: 10px;
    padding: 0.7rem 1.6rem;
    font-family: 'Heebo', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(13,27,46,0.2);
  }
  .btn-confirm-import:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(13,27,46,0.3); }
  .btn-cancel-import {
    background: none;
    color: var(--text-muted);
    border: 1.5px solid #d0dbe8;
    border-radius: 10px;
    padding: 0.7rem 1.2rem;
    font-family: 'Heebo', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-cancel-import:hover { border-color: var(--navy); color: var(--navy); }

  /* ===== INSURANCE-ONLY SAVING BLOCK ===== */
  .saving-block.insurance-only {
    border-color: rgba(192,57,43,0.4);
    background: linear-gradient(180deg, rgba(231,76,60,0.04) 0%, #fff 40%);
  }
  .saving-block.insurance-only .saving-block-header {
    background: linear-gradient(90deg, #5c1a18 0%, #7c2020 100%);
    color: #f8d9d7;
  }
  .saving-block.insurance-only .saving-block-header .saving-block-title {
    color: #f8d7d6;
  }
  /* Mixed product badge (savings + insurance coverages) */
  .insurance-mixed-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: rgba(231,76,60,0.12);
    border: 1px solid rgba(231,76,60,0.3);
    border-radius: 10px;
    padding: 0.15rem 0.5rem;
    font-size: 0.62rem;
    font-weight: 700;
    color: #c0392b;
    margin-right: 0.4rem;
  }
  /* Insurance-only report card */
  .saving-card.insurance-card .saving-card-header {
    background: linear-gradient(90deg, #5c1a18 0%, #7c2020 100%);
  }
  .saving-card.insurance-card {
    border-color: rgba(192,57,43,0.35);
  }

  /* ===== MISLAKA DEPOSITS SECTION ===== */
  .mislaka-deposits-section { margin-top: 0.6rem; }
  .deposits-header {
    background: rgba(13,27,46,0.04);
    border: 1.5px solid #dde8f2;
    border-radius: 9px;
    padding: 0.48rem 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.78rem;
    font-weight: 600;
    color: #556677;
    user-select: none;
    transition: background 0.2s;
  }
  .deposits-header:hover { background: rgba(13,27,46,0.08); }
  .deposits-header .toggle-arrow { margin-right: auto; font-size: 0.65rem; color: #8899aa; transition: transform 0.2s; display: inline-block; }
  .deposits-header.open .toggle-arrow { transform: rotate(180deg); }
  .deposits-body { display: none; padding: 0.7rem 0.3rem 0.3rem; }
  .deposits-body.open { display: block; }
  .deposits-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.74rem;
  }
  .deposits-table th {
    background: #f0f4f9;
    padding: 0.3rem 0.5rem;
    font-weight: 700;
    color: #445566;
    text-align: right;
    border-bottom: 1.5px solid #dde8f4;
  }
  .deposits-table td {
    padding: 0.28rem 0.5rem;
    color: #334455;
    border-bottom: 1px solid #eef2f8;
  }
  .deposits-table tr:last-child td { border-bottom: none; }
  .deposits-table tr:hover td { background: #f7fafd; }

  /* ===== PENSION / MISLAKA DATA TOGGLE IN FORM ===== */
  .pension-toggle { margin-top: 0.8rem; }
  .pension-toggle .toggle-header {
    background: linear-gradient(90deg, rgba(13,27,46,0.04) 0%, rgba(201,168,76,0.07) 100%);
    border: 1.5px solid rgba(201,168,76,0.28);
    border-radius: 10px;
    padding: 0.55rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.55rem;
    font-size: 0.82rem;
    font-weight: 700;
    color: #445566;
    user-select: none;
    transition: background 0.2s;
  }
  .pension-toggle .toggle-header:hover { background: rgba(201,168,76,0.13); }
  .pension-toggle .toggle-header .toggle-arrow {
    font-size: 0.68rem;
    margin-right: auto;
    color: var(--gold);
    transition: transform 0.25s;
    display: inline-block;
  }
  .pension-toggle .toggle-header.open .toggle-arrow { transform: rotate(180deg); }
  .pension-toggle .toggle-body { display: none; padding: 0.9rem 0.4rem 0.4rem; }
  .pension-toggle .toggle-body.open { display: block; }
  .pension-count-badge {
    background: rgba(201,168,76,0.15);
    border: 1px solid rgba(201,168,76,0.38);
    border-radius: 12px;
    padding: 0.1rem 0.55rem;
    font-size: 0.63rem;
    color: #a07820;
    font-weight: 700;
  }

  /* ===== INSURANCE-ONLY BADGE ===== */
  .insurance-only-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: rgba(231,76,60,0.1);
    border: 1px solid rgba(231,76,60,0.3);
    border-radius: 14px;
    padding: 0.18rem 0.65rem;
    font-size: 0.66rem;
    font-weight: 700;
    color: #c0392b;
    margin-top: 0.3rem;
  }

  /* ===== RETIREMENT PROJECTION SECTION IN MODAL ===== */
  .mp-retirement {
    border-top: 1px solid #ecf0f5;
    padding-top: 0.75rem;
    margin-top: 0.3rem;
  }
  .mp-retirement-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .mp-ret-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(155px, 1fr));
    gap: 0.45rem 1rem;
  }
  .mp-ret-item .rk { font-size: 0.62rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; display: block; margin-bottom: 0.1rem; }
  .mp-ret-item .rv { font-size: 0.85rem; font-weight: 700; color: var(--navy); }
  .mp-ret-item .rv.gold  { color: #b7860d; }
  .mp-ret-item .rv.green { color: #27ae60; }
  .mp-ret-item .rv.blue  { color: #2471a3; }

  /* Insurance card styling in modal */
  .mp-card.insurance-card { border-color: rgba(231,76,60,0.28); }
  .mp-card.insurance-card .mp-card-head {
    background: linear-gradient(90deg, #5c1a18 0%, #7a2222 100%);
  }
</style>
</head>
<body>
<div class="app">
  <!-- TABS -->
  <div class="tabs-bar">
    <button class="tab-btn active" onclick="switchTab('form')">âœï¸ ×”×–× ×ª × ×ª×•× ×™×</button>
    <button class="tab-btn" onclick="switchTab('report')" id="tab-report">ğŸ“Š ×ª×¦×•×’×ª ×¡×™×›×•×</button>
    <div class="app-logo">ğŸ’¼ InvestSummary <span>| Smart CFP Tools</span></div>
  </div>

  <!-- FORM TAB -->
  <div class="tab-content active" id="tab-form-content">
  <div class="form-page">

    <div class="form-header">
      <h1>ğŸ“‹ ×”×–× ×ª ×¤×¨×˜×™ ×œ×§×•×— ×•×ª×™×§ ×—×¡×›×•× ×•×ª</h1>
      <p>××œ× ××ª ×”×¤×¨×˜×™× ×•×œ×—×¥ "×¦×•×¨ ×“×£ ×¡×™×›×•×" - ×”×“×£ ×™×™×•×¦×¨ ××•×˜×•××˜×™×ª</p>
    </div>

    <!-- CLIENT -->
    <div class="section-card">
      <h2><span class="section-icon">ğŸ‘¤</span> ×¤×¨×˜×™ ×œ×§×•×—</h2>
      <div class="form-grid">
        <div class="field">
          <label>×©× ××œ×</label>
          <input type="text" id="client-name" placeholder="×™×©×¨××œ ×™×©×¨××œ×™">
        </div>
        <div class="field">
          <label>×ª×¢×•×“×ª ×–×”×•×ª</label>
          <input type="text" id="client-id" placeholder="000000000">
        </div>
        <div class="field">
          <label>×˜×œ×¤×•×Ÿ</label>
          <input type="text" id="client-phone" placeholder="050-0000000">
        </div>
        <div class="field">
          <label>×©× ×”×¡×•×›×Ÿ / ×™×•×¢×¥</label>
          <input type="text" id="agent-name" placeholder="×©× ×”×¡×•×›×Ÿ">
        </div>
      </div>
    </div>

    <!-- SAVINGS -->
    <div class="section-card">
      <h2><span class="section-icon">ğŸ¦</span> ×§×•×¤×•×ª / ×¤×•×œ×™×¡×•×ª / ×ª×™×§×™×</h2>
      <div class="savings-list" id="savings-list"></div>
      <button class="btn-add" onclick="addSaving()">+ ×”×•×¡×£ ×§×•×¤×” / ×¤×•×œ×™×¡×” / ×ª×™×§</button>
    </div>

    <button class="btn-generate" onclick="generateReport()">âœ¨ ×¦×•×¨ ×“×£ ×¡×™×›×•× ×œ×œ×§×•×—</button>
    <div class="csv-actions">
      <button class="btn-csv-export" onclick="exportCSV()">â¬‡ï¸ ×™×™×¦×•× CSV</button>
      <label class="btn-csv-import" for="csv-upload-input">â¬†ï¸ ×™×™×‘×•× CSV</label>
      <input type="file" id="csv-upload-input" accept=".csv" style="display:none" onchange="importCSV(this)">
    </div>

    <!-- ===== MISLAKA IMPORT ===== -->
    <div class="mislaka-section">
      <div class="mislaka-header">
        <div class="mislaka-icon-wrap">ğŸ›ï¸</div>
        <div>
          <div class="mislaka-title">×™×‘×•× ××¡×œ×§×” ×¤× ×¡×™×•× ×™×ª</div>
          <div class="mislaka-subtitle">×”×¢×œ×” ×§×•×‘×¥ ZIP ×©×”×ª×§×‘×œ ××”××¡×œ×§×” â€” ×”× ×ª×•× ×™× ×™×•×–× ×• ××•×˜×•××˜×™×ª ×œ×××©×§ ×”×¡×•×›×Ÿ ×•×ª×•×›×œ ×œ×¦×¤×•×ª ×‘×›×œ×œ ×”××™×“×¢ ×”××¤×•×¨×˜</div>
        </div>
      </div>
      <div class="mislaka-upload-row">
        <label class="btn-mislaka" for="mislaka-zip-input">
          ğŸ“‚ ×‘×—×¨ ×§×•×‘×¥ ZIP ××”××¡×œ×§×”
        </label>
        <input type="file" id="mislaka-zip-input" accept=".zip" style="display:none" onchange="importMislaka(this)">
        <div class="mislaka-status-bar" id="mislaka-status">×××ª×™×Ÿ ×œ×§×•×‘×¥ ZIP ××”××¡×œ×§×”...</div>
      </div>
    </div>

  </div>
  </div>

  <!-- REPORT TAB -->
  <div class="tab-content" id="tab-report-content">
    <div id="report-container">
      <div class="report-empty">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <p style="font-size:1rem;font-weight:600;">×¢×•×“ ×œ× × ×•×¦×¨ ×¡×™×›×•×</p>
        <p style="font-size:0.85rem;margin-top:0.3rem;">×¢×‘×•×¨ ×œ×œ×©×•× ×™×ª "×”×–× ×ª × ×ª×•× ×™×" ×•×œ×—×¥ "×¦×•×¨ ×“×£ ×¡×™×›×•×"</p>
      </div>
    </div>
  </div>
</div>

<!-- ===== MISLAKA MODAL OVERLAY ===== -->
<div class="mislaka-overlay" id="mislaka-overlay" onclick="handleOverlayClick(event)">
  <div class="mislaka-modal" id="mislaka-modal">
    <div class="mislaka-modal-head">
      <h3>ğŸ›ï¸ ×ª×¦×•×’×ª ××¡×œ×§×” â€” ×¡×§×™×¨×ª × ×ª×•× ×™× ×œ×¤× ×™ ×™×™×‘×•×</h3>
      <div style="display:flex;align-items:center;gap:0.7rem;">
        <span class="client-chip" id="mislaka-modal-client-chip"></span>
        <button class="btn-modal-close" onclick="closeMislakaModal()" title="×¡×’×•×¨">âœ•</button>
      </div>
    </div>
    <div class="mislaka-modal-body" id="mislaka-modal-body">
    </div>
    <div class="mislaka-modal-foot">
      <span class="foot-note">* ×”× ×ª×•× ×™× ×™×•×–× ×• ×œ×˜×•×¤×¡ â€” × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ××—×¨ ×”×™×™×‘×•×</span>
      <button class="btn-cancel-import" onclick="closeMislakaModal()">×‘×™×˜×•×œ</button>
      <button class="btn-confirm-import" onclick="confirmMislakaImport()">âœ… ×™×™×‘× × ×ª×•× ×™× ×œ×˜×•×¤×¡</button>
    </div>
  </div>
</div>

<script>
let savingCount = 0;

function addSaving() {
  savingCount++;
  const id = `saving-${savingCount}`;
  const list = document.getElementById('savings-list');

  const block = document.createElement('div');
  block.className = 'saving-block';
  block.id = id;
  block.innerHTML = `
    <div class="saving-block-header">
      <span class="saving-block-title">×§×•×¤×” / ×¤×•×œ×™×¡×” #${savingCount}</span>
      <div id="yield-display-${savingCount}" style="display:flex;align-items:center;gap:0.45rem;padding:0.22rem 0.9rem;border-radius:20px;border:1.5px solid #dde8f2;background:#f5faff;min-width:88px;justify-content:center;transition:background 0.3s,border-color 0.3s;">
        <span style="font-size:0.65rem;color:#aab5c8;font-weight:500;">×ª×©×•××”</span>
        <span class="yield-value" id="yield-value-${savingCount}" style="font-size:0.95rem;font-weight:800;letter-spacing:-0.01em;">-</span>
        <span id="yield-gain-${savingCount}" style="font-size:0.59rem;color:#8899aa;white-space:nowrap;"></span>
      </div>
      <button class="btn-remove" onclick="removeSaving('${id}')">âœ• ×”×¡×¨</button>
    </div>
    <div class="form-grid cols-5">
      <div class="field">
        <label>×¢×œ ×©× ××™</label>
        <input type="text" name="owner" placeholder="×©× ××œ× + ×ª.×–.">
      </div>
      <div class="field">
        <label>×—×‘×¨×” ×× ×”×œ×ª</label>
        <input type="text" name="company" placeholder="×”×¨××œ, ×¤× ×™×§×¡...">
      </div>
      <div class="field">
        <label>×¡×•×’ ××•×¦×¨</label>
        <select name="product-type" onchange="updateProductStyle(${savingCount})">
          <option value="">-- ×‘×—×¨ --</option>
          <option>×§×•×¤×ª ×’××œ</option>
          <option>×’××œ ×œ×”×©×§×¢×”</option>
          <option>×§×¨×Ÿ ×¤× ×¡×™×”</option>
          <option>×‘×™×˜×•×— ×× ×”×œ×™×</option>
          <option>×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ</option>
          <option>×§×¨×Ÿ ×”×©×ª×œ××•×ª</option>
          <option>×ª×™×§ ×× ×•×”×œ</option>
          <option>×ª×™×§ ××™×•×¢×¥</option>
          <option>× ×“×œ"×Ÿ</option>
          <option>×”×©×§×¢×” ××œ×˜×¨× ×˜×™×‘×™×ª</option>
          <option>×¨×™×¡×§</option>
          <option>×‘×™×˜×•×— ×—×™×™×</option>
          <option>×‘×™×˜×•×— ××©×›× ×ª×</option>
          <option>××•×‘×“×Ÿ ×›×•×©×¨ ×¢×‘×•×“×”</option>
          <option>××—×¨</option>
        </select>
      </div>
      <div class="field">
        <label>××¡×¤×¨ ×§×•×¤×” / ×¤×•×œ×™×¡×”</label>
        <input type="text" name="policy-num" placeholder="××¡×¤×¨">
      </div>
      <div class="field">
        <label>×¡×˜×˜×•×¡</label>
        <select name="status">
          <option value="×”×•×¤×§">×”×•×¤×§ âœ…</option>
          <option value="×‘×”×§××”">×‘×”×§××” ğŸ”„</option>
          <option value="×‘×•×˜×œ">×‘×•×˜×œ âŒ</option>
          <option value="× ×¤×“×”">× ×¤×“×” ğŸ’°</option>
        </select>
      </div>
    </div>

    <div class="form-grid cols-5" style="margin-top:0.8rem;">
      <div class="field">
        <label>×ª××¨×™×š ×¤×ª×™×—×ª ×§×•×¤×”</label>
        <input type="date" name="open-date" oninput="calcYield('${savingCount}')">
      </div>
      <div class="field">
        <label>××˜×¨×ª ×”×§×•×¤×”</label>
        <input type="text" name="goal" placeholder="×™×œ×“×™×, ×¤×¨×™×©×”, ×—×™×¨×•×...">
      </div>
      <div class="field">
        <label>×™×ª×¨×” × ×•×›×—×™×ª (â‚ª)</label>
        <input type="number" name="balance" placeholder="0" oninput="calcLoanPayment('${savingCount}');calcYield('${savingCount}')">
      </div>
      <div class="field">
        <label>×ª××¨×™×š ×¢×“×›×•×Ÿ ×™×ª×¨×”</label>
        <input type="date" name="balance-date" value="${new Date().toISOString().slice(0,10)}">
      </div>
      <div class="field">
        <label>× ×–×™×œ×•×ª</label>
        <select name="liquidity" onchange="toggleLiqDate(this,'liq-date-wrap-${savingCount}')">
          <option value="× ×–×™×œ">ğŸ’§ × ×–×™×œ</option>
          <option value="×œ× × ×–×™×œ">ğŸ”’ ×œ× × ×–×™×œ</option>
        </select>
      </div>
    </div>

    <div class="form-grid cols-5" style="margin-top:0.8rem;">
      <div class="field">
        <label>×”×¤×§×“×” ×—×“-×¤×¢××™×ª (â‚ª)</label>
        <input type="number" name="one-time" placeholder="0" oninput="toggleField(this,'one-time-date-wrap-${savingCount}');calcYield('${savingCount}')">
      </div>
      <div class="field">
        <label>×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª)</label>
        <input type="number" name="monthly" placeholder="0" oninput="calcYield('${savingCount}')">
      </div>
      <div class="field">
        <label>×“.× . ××”×¤×§×“×” (%)</label>
        <input type="number" name="fee-deposit" placeholder="0.00" step="0.01" min="0" max="6">
      </div>
      <div class="field">
        <label>×“.× . ××¦×‘×™×¨×” (%)</label>
        <input type="number" name="fee-accumulation" placeholder="0.00" step="0.01" min="0" max="3">
      </div>
      <div class="field" id="liq-date-wrap-${savingCount}" style="display:none">
        <label>×ª××¨×™×š × ×–×™×œ×•×ª</label>
        <input type="date" name="liquidity-date">
      </div>
      <div class="field" id="one-time-date-wrap-${savingCount}" style="display:none">
        <label>×ª××¨×™×š ×”×¤×§×“×” ×—×“-×¤×¢××™×ª</label>
        <input type="date" name="one-time-date">
      </div>
    </div>

    <!-- LOAN -->
    <div class="toggle-section" style="margin-top:0.8rem;">
      <div class="toggle-header" onclick="toggleLoanSection('loan-body-${savingCount}','has-loan-${savingCount}')">
        <input type="checkbox" name="has-loan" id="has-loan-${savingCount}" onchange="toggleLoanSection('loan-body-${savingCount}','has-loan-${savingCount}')">
        <label for="has-loan-${savingCount}" style="cursor:pointer;">ğŸ’³ × ×œ×§×—×” ×”×œ×•×•××” ××§×•×¤×” ×–×•</label>
      </div>
      <div class="toggle-body" id="loan-body-${savingCount}">
        <div class="form-grid cols-4">
          <div class="field">
            <label>×ª××¨×™×š ×”×œ×•×•××”</label>
            <input type="date" name="loan-date">
          </div>
          <div class="field">
            <label>×¡×›×•× ×”×œ×•×•××” (â‚ª)</label>
            <input type="number" name="loan-amount" placeholder="0" oninput="calcLoanPayment('${savingCount}')">
          </div>
          <div class="field">
            <label>×¨×™×‘×™×ª ×©× ×ª×™×ª (%)</label>
            <input type="number" name="loan-rate" placeholder="0.00" step="0.01" oninput="calcLoanPayment('${savingCount}')">
          </div>
          <div class="field">
            <label>×ª×§×•×¤×” (×—×•×“×©×™×)</label>
            <input type="number" name="loan-duration" placeholder="12" oninput="calcLoanPayment('${savingCount}')">
          </div>
          <div class="field">
            <label>×¡×•×’ ×”×œ×•×•××”</label>
            <select name="loan-type">
              <option>×§×œ"×¦</option>
              <option>×¦××•×“×ª ××“×“</option>
              <option>×¤×¨×™×™×</option>
              <option>×§×‘×•×¢×” ×œ× ×¦××•×“×”</option>
              <option>××—×¨</option>
            </select>
          </div>
          <div class="field">
            <label>×¡×•×’ ×”×—×–×¨</label>
            <select name="loan-repay" onchange="calcLoanPayment('${savingCount}')">
              <option value="×©×¤×™×¦×¨">×©×¤×™×¦×¨</option>
              <option value="×‘×œ×•×Ÿ">×‘×œ×•×Ÿ</option>
              <option value="×’×¨×™×™×¡">×’×¨×™×™×¡</option>
              <option value="×§×¨×Ÿ ×©×•×•×”">×§×¨×Ÿ ×©×•×•×”</option>
            </select>
          </div>
          <div class="field">
            <label>×”×—×–×¨ ×—×•×“×©×™ (â‚ª) <span id="loan-auto-label-${savingCount}" style="color:#b7760d;font-size:0.68rem;font-weight:600;"></span></label>
            <input type="number" name="loan-monthly" id="loan-monthly-${savingCount}" placeholder="0" style="font-weight:700;">
          </div>
          <div class="field">
            <label>××˜×¨×ª ×”×”×œ×•×•××”</label>
            <input type="text" name="loan-goal" placeholder="×œ××©×œ: ×©×™×¤×•×¥, ×¨×›×™×©×ª × ×›×¡...">
          </div>
        </div>
      </div>
    </div>
    <!-- DEPOSITS FROM MISLAKA -->
    <div class="mislaka-deposits-section" id="deposits-section-${savingCount}">
      <div class="deposits-header" id="deposits-header-${savingCount}" onclick="toggleDepositsSection(${savingCount})">
        ğŸ“‹ ×”×¤×§×“×•×ª ××”××¡×œ×§×” <span class="pension-count-badge">××¡×œ×§×”</span>
        <span class="toggle-arrow">â–¼</span>
      </div>
      <div class="deposits-body" id="deposits-body-${savingCount}">
        <div id="deposits-content-${savingCount}" style="color:#8899aa;font-size:0.78rem;padding:0.3rem 0.2rem;">×œ× ×™×•×‘××• × ×ª×•× ×™ ×”×¤×§×“×•×ª</div>
      </div>
    </div>

    <!-- PENSION / MISLAKA PROJECTIONS -->
    <div class="pension-toggle" id="pension-toggle-${savingCount}">
      <div class="toggle-header" id="pension-header-${savingCount}" onclick="togglePensionSection(${savingCount})">
        ğŸ›ï¸ ×ª×—×–×™×•×ª ×¤×¨×™×©×” ×××¡×œ×§×” <span class="pension-count-badge">××¡×œ×§×”</span>
        <span class="toggle-arrow">â–¼</span>
      </div>
      <div class="toggle-body" id="pension-body-${savingCount}">
        <input type="hidden" name="retirement-age">
        <div class="form-grid cols-4">
          <div class="field">
            <label>×—×™×¡×›×•×Ÿ ×¦×¤×•×™ ×¢× ×”×¤×§×“×•×ª (â‚ª)</label>
            <input type="number" name="proj-savings-with" placeholder="0">
          </div>
          <div class="field">
            <label>×—×™×¡×›×•×Ÿ ×¦×¤×•×™ ×œ×œ× ×”×¤×§×“×•×ª (â‚ª)</label>
            <input type="number" name="proj-savings-without" placeholder="0">
          </div>
          <div class="field">
            <label>×§×¦×‘×” ×—×•×“×©×™×ª ×¢× ×”×¤×§×“×•×ª (â‚ª)</label>
            <input type="number" name="proj-pension-with" placeholder="0">
          </div>
          <div class="field">
            <label>×§×¦×‘×” ×—×•×“×©×™×ª ×œ×œ× ×”×¤×§×“×•×ª (â‚ª)</label>
            <input type="number" name="proj-pension-without" placeholder="0">
          </div>
        </div>
      </div>
    </div>

    <!-- RECOMMENDATION -->
    <div class="rec-form-block">
      <div class="rec-form-header">ğŸ“‹ ×”××œ×¦×” ×•×ª×›× ×•×Ÿ ×œ×¤×’×™×©×” ×”×‘××”</div>
      <div class="rec-form-body">
        <div>
          <label style="font-size:0.75rem;font-weight:600;color:#556;display:block;margin-bottom:0.3rem;">×¡×•×’ ×¤×¢×•×œ×” ××•××œ×¦×ª</label>
          <select name="rec-type" class="rec-type-select">
            <option value="">â€” ×œ×œ× ×”××œ×¦×” â€”</option>
            <option value="×œ×”××©×™×š ×œ×œ× ×©×™× ×•×™">âœ… ×œ×”××©×™×š ×œ×œ× ×©×™× ×•×™</option>
            <option value="×œ×‘×—×•×Ÿ ×”×¢×‘×¨×” ×œ×—×‘×¨×” ××—×¨×ª">ğŸ”„ ×œ×‘×—×•×Ÿ ×”×¢×‘×¨×” ×œ×—×‘×¨×” ××—×¨×ª</option>
            <option value="×œ×©× ×•×ª ××¡×œ×•×œ ×”×©×§×¢×”">ğŸ“Š ×œ×©× ×•×ª ××¡×œ×•×œ ×”×©×§×¢×”</option>
            <option value="×œ×¢×¦×•×¨ ×”×¤×§×“×•×ª ×—×•×“×©×™×•×ª">â¸ ×œ×¢×¦×•×¨ ×”×¤×§×“×•×ª ×—×•×“×©×™×•×ª</option>
            <option value="×œ×××© ×•×œ×¤×“×•×ª">ğŸ’° ×œ×××© ×•×œ×¤×“×•×ª</option>
            <option value="×œ××—×“ ×¢× ××•×¦×¨ ××—×¨">ğŸ”— ×œ××—×“ ×¢× ××•×¦×¨ ××—×¨</option>
            <option value="×œ×‘×—×•×Ÿ ×‘×™×˜×•×œ">ğŸš« ×œ×‘×—×•×Ÿ ×‘×™×˜×•×œ</option>
            <option value="×œ×”×’×“×™×œ ×”×¤×§×“×•×ª">ğŸ“ˆ ×œ×”×’×“×™×œ ×”×¤×§×“×•×ª</option>
            <option value="×œ×‘×—×•×Ÿ ××—×“×© ×‘×¤×’×™×©×” ×”×‘××”">ğŸ” ×œ×‘×—×•×Ÿ ××—×“×© ×‘×¤×’×™×©×” ×”×‘××”</option>
            <option value="×™×™×¢×•×¥ × ×•×¡×£ × ×“×¨×©">ğŸ“ ×™×™×¢×•×¥ × ×•×¡×£ × ×“×¨×©</option>
          </select>
        </div>
        <div>
          <label style="font-size:0.75rem;font-weight:600;color:#556;display:block;margin-bottom:0.3rem;">×¢×“×™×¤×•×ª</label>
          <div class="rec-priority-group">
            <button type="button" class="rec-priority-btn high" onclick="setPriority(this,'high')">ğŸ”´ ×’×‘×•×”×”</button>
            <button type="button" class="rec-priority-btn mid"  onclick="setPriority(this,'mid')">ğŸŸ¡ ×‘×™× ×•× ×™×ª</button>
            <button type="button" class="rec-priority-btn low"  onclick="setPriority(this,'low')">ğŸŸ¢ × ××•×›×”</button>
          </div>
          <input type="hidden" name="rec-priority" value="">
        </div>
        <div>
          <label style="font-size:0.75rem;font-weight:600;color:#556;display:block;margin-bottom:0.3rem;">×œ×‘×™×¦×•×¢ ×¢×“</label>
          <input type="date" name="rec-date" style="font-family:'Heebo',sans-serif;font-size:0.82rem;padding:0.45rem 0.7rem;border:1.5px solid #d0dbe8;border-radius:7px;width:100%;">
        </div>
        <div class="rec-form-notes">
          <label style="font-size:0.75rem;font-weight:600;color:#556;display:block;margin-bottom:0.3rem;">×¤×™×¨×•×˜ / ×”×¢×¨×•×ª</label>
          <textarea name="rec-notes" placeholder="×¤×¨×˜ ××ª ×”×¡×™×‘×” ×œ×”××œ×¦×”, ×©×œ×‘×™ ×‘×™×¦×•×¢, ××• ×›×œ ××™×“×¢ ×¨×œ×•×•× ×˜×™..."></textarea>
        </div>
      </div>
    </div>
  `;
  list.appendChild(block);
}

function calcYield(n) {
  const block = document.getElementById(`saving-${n}`);
  if (!block) return;
  const balance = parseFloat(block.querySelector('[name="balance"]')?.value) || 0;
  const openDate = block.querySelector('[name="open-date"]')?.value;
  const monthly = parseFloat(block.querySelector('[name="monthly"]')?.value) || 0;
  const oneTime = parseFloat(block.querySelector('[name="one-time"]')?.value) || 0;
  const yieldVal = document.getElementById(`yield-value-${n}`);
  const yieldGain = document.getElementById(`yield-gain-${n}`);
  const yieldDisplay = document.getElementById(`yield-display-${n}`);

  if (!balance || !openDate) {
    if (yieldVal) { yieldVal.textContent = '-'; yieldVal.className = 'yield-value'; }
    if (yieldGain) yieldGain.textContent = !openDate && balance ? '×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š ×¤×ª×™×—×”' : '';
    if (yieldDisplay) { yieldDisplay.style.background = '#f5faff'; yieldDisplay.style.borderColor = '#dde8f2'; }
    return;
  }

  const open = new Date(openDate);
  const now = new Date();
  const months = Math.max(0, Math.round((now - open) / (1000 * 60 * 60 * 24 * 30.44)));
  const deposits = oneTime + (monthly * months);

  if (!deposits) {
    if (yieldVal) { yieldVal.textContent = '-'; yieldVal.className = 'yield-value'; }
    if (yieldGain) yieldGain.textContent = '××™×Ÿ ×”×¤×§×“×•×ª ××•×–× ×•×ª';
    return;
  }

  const gain = balance - deposits;
  const pct = (gain / deposits) * 100;
  const sign = gain >= 0 ? '+' : '';

  if (yieldVal) {
    yieldVal.textContent = `${sign}${pct.toFixed(2)}%`;
    yieldVal.className = 'yield-value ' + (pct > 2 ? 'positive' : pct < 0 ? 'negative' : 'neutral');
  }
  if (yieldGain) yieldGain.textContent = `Â· ${sign}${Number(Math.abs(gain)).toLocaleString('he-IL', {maximumFractionDigits:0})}â‚ª`;
  if (yieldDisplay) {
    yieldDisplay.style.background = pct > 2 ? '#edfaf3' : pct < 0 ? '#fef0ef' : '#fffbec';
    yieldDisplay.style.borderColor = pct > 2 ? '#a8e8c0' : pct < 0 ? '#f5b7b0' : '#f5d98a';
  }
}

function calcLoanPayment(n) {
  const block = document.getElementById(`saving-${n}`);
  if (!block) return;
  const amount = parseFloat(block.querySelector('[name="loan-amount"]')?.value) || 0;
  const balance = parseFloat(block.querySelector('[name="balance"]')?.value) || 0;
  const annualRate = parseFloat(block.querySelector('[name="loan-rate"]')?.value) || 0;
  const months = parseInt(block.querySelector('[name="loan-duration"]')?.value) || 0;
  const repayType = block.querySelector('[name="loan-repay"]')?.value || '×©×¤×™×¦×¨';
  const monthlyInput = document.getElementById(`loan-monthly-${n}`);
  const label = document.getElementById(`loan-auto-label-${n}`);
  const loanAmountInput = block.querySelector('[name="loan-amount"]');

  // Validation: loan cannot exceed balance
  if (amount > 0 && balance > 0 && amount > balance) {
    loanAmountInput.style.borderColor = '#e74c3c';
    loanAmountInput.style.background = '#fff5f5';
    let warn = document.getElementById(`loan-warn-${n}`);
    if (!warn) {
      warn = document.createElement('div');
      warn.id = `loan-warn-${n}`;
      warn.style.cssText = 'color:#c0392b;font-size:0.72rem;font-weight:600;margin-top:0.3rem;grid-column:1/-1;';
      loanAmountInput.closest('.field').insertAdjacentElement('afterend', warn);
    }
    warn.textContent = `âš ï¸ ×¡×›×•× ×”×”×œ×•×•××” (${fmtCurrency(amount)}) ×—×•×¨×’ ××’×•×‘×” ×”×—×™×¡×›×•×Ÿ (${fmtCurrency(balance)})`;
    if (label) label.textContent = '';
    return;
  } else {
    if (loanAmountInput) { loanAmountInput.style.borderColor = ''; loanAmountInput.style.background = ''; }
    const warn = document.getElementById(`loan-warn-${n}`);
    if (warn) warn.remove();
  }

  if (!amount || !months) { if (label) label.textContent = ''; return; }

  let monthly = 0;
  const r = annualRate / 100 / 12;

  if (repayType === '×‘×œ×•×Ÿ') {
    monthly = r > 0 ? amount * r : 0;
  } else if (repayType === '×§×¨×Ÿ ×©×•×•×”') {
    monthly = amount / months + (amount * r);
  } else {
    if (r === 0) { monthly = amount / months; }
    else { monthly = amount * (r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1); }
  }

  if (monthly > 0 && monthlyInput) {
    monthlyInput.value = Math.round(monthly);
    if (label) label.textContent = '(×—×•×©×‘ ××•×˜×•××˜×™×ª)';
    monthlyInput.style.background = '#fffbea';
    monthlyInput.style.borderColor = '#c9a84c';
  }
}

function removeSaving(id) {
  document.getElementById(id).remove();
}

function toggleLoanSection(bodyId, cbId) {
  const body = document.getElementById(bodyId);
  const cb = document.getElementById(cbId);
  if (!body) return;
  // if called from onclick on header (not checkbox), toggle checkbox too
  if (document.activeElement !== cb) {
    cb.checked = !cb.checked;
  }
  if (cb.checked) {
    body.classList.add('open');
  } else {
    body.classList.remove('open');
  }
}

function togglePensionSection(n) {
  const header = document.getElementById('pension-header-' + n);
  const body   = document.getElementById('pension-body-'   + n);
  if (!header || !body) return;
  header.classList.toggle('open');
  body.classList.toggle('open');
}

function toggleDepositsSection(n) {
  const header = document.getElementById('deposits-header-' + n);
  const body   = document.getElementById('deposits-body-'   + n);
  if (!header || !body) return;
  header.classList.toggle('open');
  body.classList.toggle('open');
}

// Insurance-only product types
const INSURANCE_TYPES = ['×¨×™×¡×§','×‘×™×˜×•×— ×—×™×™×','×‘×™×˜×•×— ××©×›× ×ª×','××•×‘×“×Ÿ ×›×•×©×¨ ×¢×‘×•×“×”'];

function updateProductStyle(n) {
  const block = document.getElementById('saving-' + n);
  if (!block) return;
  const typeEl = block.querySelector('[name="product-type"]');
  if (!typeEl) return;
  const isIns = INSURANCE_TYPES.includes(typeEl.value);
  block.classList.toggle('insurance-only', isIns);
}

// Map SUG-HAFRASHA code â†’ Hebrew label
function mapHafrashaType(code, depositorCode) {
  const depositor = depositorCode === '3' ? '××¢×¡×™×§' : '×¢××™×ª';
  const types = { '1': '×¢×•×‘×“', '2': '××¢×¡×™×§', '3': '×—×“-×¤×¢××™', '4': '×¤×™×¦×•×™×™×',
                  '8': '××—×¨', '9': '××—×¨', '10': '××—×¨' };
  return (types[code] || ('×¡×•×’ ' + code)) + (depositorCode && code !== '2' && code !== '4' ? ' (' + depositor + ')' : '');
}

// Render deposit history as an HTML table
function renderDepositsTable(depositHistory) {
  if (!depositHistory || !depositHistory.length) return '<div style="color:#aaa;font-size:0.75rem;">××™×Ÿ × ×ª×•× ×™ ×”×¤×§×“×•×ª</div>';
  const rows = depositHistory
    .filter(d => d.amt && parseFloat(d.amt) > 0)
    .map(d => {
      const dateStr = d.date && d.date.length >= 8
        ? d.date.substring(0,4) + '-' + d.date.substring(4,6) + '-' + d.date.substring(6,8)
        : d.date || '';
      const fmtAmt = parseFloat(d.amt) ? 'â‚ª' + parseFloat(d.amt).toLocaleString('he-IL', {maximumFractionDigits:2}) : '-';
      const fmtPct = d.pct && parseFloat(d.pct) > 0 ? parseFloat(d.pct).toFixed(1) + '%' : '';
      return `<tr>
        <td>${dateStr ? dateStr.substring(0,7) : 'â€”'}</td>
        <td>${mapHafrashaType(d.sug, d.depositor)}</td>
        <td style="font-weight:700;color:#2471a3;">${fmtPct}</td>
        <td style="font-weight:700;color:#27ae60;">${fmtAmt}</td>
      </tr>`;
    });
  if (!rows.length) return '<div style="color:#aaa;font-size:0.75rem;">××™×Ÿ × ×ª×•× ×™ ×”×¤×§×“×•×ª</div>';
  return `<table class="deposits-table">
    <thead><tr><th>×ª××¨×™×š</th><th>×¡×•×’ ×”×¤×§×“×”</th><th>××—×•×–</th><th>×¡×›×•×</th></tr></thead>
    <tbody>${rows.join('')}</tbody>
  </table>`;
}

function toggleLiqDate(sel, wrapId) {
  const wrap = document.getElementById(wrapId);
  wrap.style.display = sel.value === '×œ× × ×–×™×œ' ? 'flex' : 'none';
}

function toggleField(input, wrapId) {
  const wrap = document.getElementById(wrapId);
  wrap.style.display = input.value && input.value > 0 ? 'flex' : 'none';
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

  if (tab === 'form') {
    document.querySelectorAll('.tab-btn')[0].classList.add('active');
    document.getElementById('tab-form-content').classList.add('active');
  } else {
    document.querySelectorAll('.tab-btn')[1].classList.add('active');
    document.getElementById('tab-report-content').classList.add('active');
  }
}

function fmtCurrency(n) {
  if (!n || n == 0) return '-';
  return 'â‚ª' + Number(n).toLocaleString('he-IL');
}

function setPriority(btn, level) {
  const group = btn.closest('.rec-priority-group');
  group.querySelectorAll('.rec-priority-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const block = btn.closest('.saving-block');
  if (block) block.querySelector('[name="rec-priority"]').value = level;
}

function fmtDate(d) {
  if (!d) return '-';
  const parts = d.split('-');
  return parts[2] + '/' + parts[1] + '/' + parts[0];
}

function savePDF(clientName) {
  const today = new Date();
  const dd = String(today.getDate()).padStart(2,'0');
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const yyyy = today.getFullYear();
  const dateStr = `${dd}-${mm}-${yyyy}`;
  const prev = document.title;
  document.title = `×¡×™×›×•× - ${clientName || '×œ×§×•×—'} ${dateStr}`;
  window.print();
  setTimeout(() => { document.title = prev; }, 2000);
}

function generateReport() {
  const name = document.getElementById('client-name').value || '×œ×§×•×—';
  const clientId = document.getElementById('client-id').value || '-';
  const phone = document.getElementById('client-phone').value || '';
  const agent = document.getElementById('agent-name').value || '';

  const blocks = document.querySelectorAll('.saving-block');
  const savings = [];

  blocks.forEach(block => {
    const g = (name) => block.querySelector(`[name="${name}"]`)?.value || '';
    savings.push({
      owner: g('owner'),
      company: g('company'),
      productType: g('product-type'),
      policyNum: g('policy-num'),
      status: g('status'),
      goal: g('goal'),
      balance: g('balance'),
      balanceDate: g('balance-date'),
      openDate: g('open-date'),
      totalDeposits: g('total-deposits'),
      oneTime: g('one-time'),
      oneTimeDate: g('one-time-date'),
      monthly: g('monthly'),
      liquidity: g('liquidity'),
      liquidityDate: g('liquidity-date'),
      hasLoan: block.querySelector('[name="has-loan"]')?.checked,
      loanDate: g('loan-date'),
      loanAmount: g('loan-amount'),
      loanRate: g('loan-rate'),
      loanDuration: g('loan-duration'),
      loanType: g('loan-type'),
      loanRepay: g('loan-repay'),
      loanMonthly: g('loan-monthly'),
      loanGoal: g('loan-goal'),
      feeDeposit:        g('fee-deposit'),
      feeAccumulation:   g('fee-accumulation'),
      retirementAge:     g('retirement-age'),
      projSavingsWith:   g('proj-savings-with'),
      projSavingsWithout:g('proj-savings-without'),
      projPensionWith:   g('proj-pension-with'),
      projPensionWithout:g('proj-pension-without'),
      recType: g('rec-type'),
      recPriority: g('rec-priority'),
      recDate: g('rec-date'),
      recNotes: g('rec-notes'),
    });
  });

  // Totals
  const liquidSavings = savings.filter(s => s.liquidity === '× ×–×™×œ');
  const nonLiquidSavings = savings.filter(s => s.liquidity === '×œ× × ×–×™×œ');
  const totalLiquidBalance = liquidSavings.reduce((sum, s) => sum + (Number(s.balance) || 0), 0);
  const totalNonLiquidBalance = nonLiquidSavings.reduce((sum, s) => sum + (Number(s.balance) || 0), 0);
  const totalLoans = savings.reduce((sum, s) => sum + (s.hasLoan ? Number(s.loanAmount) || 0 : 0), 0);
  const totalLoanMonthly = savings.reduce((sum, s) => sum + (s.hasLoan ? Number(s.loanMonthly) || 0 : 0), 0);
  const totalMonthly = savings.reduce((sum, s) => sum + (Number(s.monthly) || 0), 0);
  const totalBalance = savings.reduce((sum, s) => sum + (Number(s.balance) || 0), 0);

  const statusClass = (s) => {
    if (s === '×”×•×¤×§') return 'status-active';
    if (s === '×‘×”×§××”') return 'status-pending';
    if (s === '×‘×•×˜×œ') return 'status-cancelled';
    if (s === '× ×¤×“×”') return 'status-redeemed';
    return 'status-active';
  };

  const calcYieldData = (s) => {
    const bal = Number(s.balance) || 0;
    if (!bal || !s.openDate) return null;
    const open = new Date(s.openDate);
    const now = new Date();
    const months = Math.max(0, Math.round((now - open) / (1000 * 60 * 60 * 24 * 30.44)));
    const dep = (Number(s.oneTime) || 0) + ((Number(s.monthly) || 0) * months);
    if (!dep) return null;
    const gain = bal - dep;
    const pct = (gain / dep) * 100;
    return { pct, gain, months, sign: gain >= 0 ? '+' : '' };
  };

  const today = new Date().toLocaleDateString('he-IL');
  const cardCols = savings.length <= 4 ? 2 : savings.length <= 9 ? 3 : 4;
  const n = savings.length;

  // Dynamic print sizing: scale cards to fit all on page 1
  // More cards = smaller fonts/padding
  let cardPrintStyle = '';
  if (n <= 2) {
    cardPrintStyle = `
      .saving-card-header { padding: 7pt 9pt !important; }
      .saving-card-body { padding: 6pt 9pt !important; }
      .card-row { padding: 3.5pt 0 !important; }
      .card-row .key { font-size: 7pt !important; }
      .card-row .val { font-size: 7.5pt !important; }
      .saving-card-header .company { font-size: 8.5pt !important; }
      .loan-block { padding: 4pt 6pt !important; }
      .rec-card-block { padding-top: 3pt !important; }
      .rec-card-pill { font-size: 6pt !important; }`;
  } else if (n <= 4) {
    cardPrintStyle = `
      .saving-card-header { padding: 6pt 8pt !important; }
      .saving-card-body { padding: 5pt 8pt !important; }
      .card-row { padding: 3pt 0 !important; }
      .card-row .key { font-size: 6.5pt !important; }
      .card-row .val { font-size: 7pt !important; }
      .saving-card-header .company { font-size: 8pt !important; }
      .loan-block { padding: 3pt 5pt !important; }`;
  } else if (n <= 6) {
    cardPrintStyle = `
      .saving-card-header { padding: 4pt 6pt !important; }
      .saving-card-body { padding: 4pt 6pt !important; }
      .card-row { padding: 2pt 0 !important; }
      .card-row .key { font-size: 5.5pt !important; }
      .card-row .val { font-size: 6pt !important; }
      .saving-card-header .company { font-size: 7pt !important; }
      .saving-card-header .policy { font-size: 5pt !important; }
      .loan-block { padding: 2.5pt 4pt !important; margin-top: 2pt !important; }
      .rec-card-pill { font-size: 5pt !important; padding: 1pt 2.5pt !important; }
      .rec-card-text { font-size: 5pt !important; }
      .cards-grid { gap: 4pt !important; }`;
  } else if (n <= 9) {
    cardPrintStyle = `
      .saving-card-header { padding: 3pt 5pt !important; }
      .saving-card-body { padding: 3pt 5pt !important; }
      .card-row { padding: 1.5pt 0 !important; }
      .card-row .key { font-size: 5pt !important; }
      .card-row .val { font-size: 5.5pt !important; }
      .saving-card-header .company { font-size: 6.5pt !important; }
      .saving-card-header .policy { font-size: 4.5pt !important; }
      .saving-card-status { font-size: 4pt !important; padding: 0.5pt 2pt !important; }
      .liquidity-badge { font-size: 4.5pt !important; padding: 0.5pt 2pt !important; }
      .loan-block { padding: 2pt 3pt !important; margin-top: 1.5pt !important; }
      .loan-title { font-size: 4.5pt !important; margin-bottom: 1pt !important; }
      .loan-item .k { font-size: 4.5pt !important; }
      .loan-item .v { font-size: 5pt !important; }
      .rec-card-block { padding-top: 2pt !important; margin-top: 1.5pt !important; }
      .rec-card-pill { font-size: 4.5pt !important; padding: 0.5pt 2pt !important; }
      .rec-card-text { display: none !important; }
      .rec-card-date { display: none !important; }
      .owner-tag { display: none !important; }
      .cards-grid { gap: 3pt !important; }
      .summary-banner { padding: 5pt 10pt !important; }
      .summary-banner .stat-value { font-size: 11pt !important; }
      .summary-banner .stat-label { font-size: 5.5pt !important; }
      .summary-banner .stat-sub { font-size: 5pt !important; }
      .report-section-title { font-size: 6pt !important; margin-bottom: 3pt !important; }`;
  } else {
    // 10-12 cards: very compact
    cardPrintStyle = `
      .saving-card-header { padding: 3pt 5pt !important; }
      .saving-card-body { padding: 3pt 5pt !important; }
      .card-row { padding: 1.5pt 0 !important; }
      .card-row .key { font-size: 5pt !important; }
      .card-row .val { font-size: 5.5pt !important; }
      .saving-card-header .company { font-size: 6.5pt !important; }
      .saving-card-header .policy { font-size: 4.5pt !important; }
      .saving-card-status { font-size: 4.5pt !important; padding: 0.5pt 2.5pt !important; }
      .liquidity-badge { font-size: 4.5pt !important; }
      .loan-block { padding: 2pt 3pt !important; margin-top: 1.5pt !important; }
      .loan-item .k, .loan-item .v { font-size: 4.5pt !important; }
      .rec-card-block, .rec-card-text, .rec-card-date { display:none !important; }
      .owner-tag { display:none !important; }`;
  }

  // Dynamic table page CSS based on savings count
  let tablePrintStyle = '';
  if (n <= 5) {
    tablePrintStyle = `
      .compact-table thead th { padding: 4pt 5pt !important; font-size: 7pt !important; }
      .compact-table tbody td { padding: 4pt 5pt !important; font-size: 7.5pt !important; }
      .compact-table tfoot td { padding: 4pt 5pt !important; font-size: 7.5pt !important; }`;
  } else if (n <= 9) {
    tablePrintStyle = `
      .compact-table thead th { padding: 2.5pt 3pt !important; font-size: 6pt !important; }
      .compact-table tbody td { padding: 2.5pt 3pt !important; font-size: 6.5pt !important; }
      .compact-table tfoot td { padding: 2.5pt 3pt !important; font-size: 6.5pt !important; }
      .saving-card-status { font-size: 5pt !important; padding: 0.5pt 2pt !important; }
      .bottom-summary { padding: 5pt 8pt !important; margin-top: 4pt !important; }
      .bs-value { font-size: 11pt !important; }`;
  } else {
    tablePrintStyle = `
      .compact-table thead th { padding: 2pt 2.5pt !important; font-size: 5.5pt !important; }
      .compact-table tbody td { padding: 2pt 2.5pt !important; font-size: 6pt !important; }
      .compact-table tfoot td { padding: 2pt 2.5pt !important; font-size: 6pt !important; }
      .saving-card-status { font-size: 4.5pt !important; padding: 0.5pt 1.5pt !important; }
      .bottom-summary { padding: 4pt 7pt !important; margin-top: 3pt !important; }
      .bs-value { font-size: 10pt !important; }
      .loans-table thead th { padding: 2pt 2.5pt !important; font-size: 5.5pt !important; }
      .loans-table tbody td { padding: 2pt 2.5pt !important; font-size: 6pt !important; }`;
  }

  // Dynamic planning page CSS
  const withRecCount = savings.filter(s => s.recType && s.recType !== '' && s.recType !== '×œ×”××©×™×š ×œ×œ× ×©×™× ×•×™').length;
  let planPrintStyle = '';
  if (withRecCount <= 4) {
    planPrintStyle = `
      .planning-header { padding: 8pt 12pt !important; }
      .planning-header h3 { font-size: 11pt !important; }
      .planning-body { padding: 8pt 12pt !important; }
      .planning-row { padding: 5pt 7pt !important; margin-bottom: 4pt !important; }
      .planning-group { margin-bottom: 10pt !important; }`;
  } else if (withRecCount <= 8) {
    planPrintStyle = `
      .planning-header { padding: 6pt 10pt !important; }
      .planning-header h3 { font-size: 10pt !important; }
      .planning-header .ph-sub { font-size: 6.5pt !important; }
      .planning-header .ph-stat .n { font-size: 11pt !important; }
      .planning-header .ph-stat .l { font-size: 5.5pt !important; }
      .planning-header .ph-stat { padding: 3pt 6pt !important; }
      .planning-body { padding: 7pt 10pt !important; }
      .planning-group { margin-bottom: 7pt !important; }
      .planning-group-title { font-size: 6.5pt !important; margin-bottom: 4pt !important; padding-bottom: 3pt !important; }
      .planning-row { padding: 4pt 6pt !important; margin-bottom: 3pt !important; border-radius: 5pt !important; }
      .pr-num { font-size: 7pt !important; min-width: 14pt !important; height: 14pt !important; }
      .pr-action { font-size: 7.5pt !important; }
      .pr-who { font-size: 6.5pt !important; }
      .pr-note { font-size: 6pt !important; margin-top: 1.5pt !important; }
      .pr-date { font-size: 5.5pt !important; padding: 1pt 4pt !important; }
      .planning-no-action { padding: 4pt 8pt !important; font-size: 6.5pt !important; }`;
  } else {
    planPrintStyle = `
      .planning-header { padding: 5pt 9pt !important; }
      .planning-header h3 { font-size: 9pt !important; }
      .planning-header .ph-sub { font-size: 6pt !important; }
      .planning-header .ph-stat .n { font-size: 10pt !important; }
      .planning-header .ph-stat .l { font-size: 5pt !important; }
      .planning-header .ph-stat { padding: 2pt 5pt !important; }
      .planning-body { padding: 5pt 8pt !important; }
      .planning-group { margin-bottom: 5pt !important; }
      .planning-group-title { font-size: 6pt !important; margin-bottom: 3pt !important; padding-bottom: 2pt !important; }
      .planning-row { padding: 3pt 5pt !important; margin-bottom: 2pt !important; border-radius: 4pt !important; gap: 4pt !important; }
      .pr-num { font-size: 6pt !important; min-width: 12pt !important; height: 12pt !important; }
      .pr-action { font-size: 7pt !important; }
      .pr-who { font-size: 6pt !important; }
      .pr-note { font-size: 5.5pt !important; margin-top: 1pt !important; }
      .pr-date { font-size: 5pt !important; padding: 0.5pt 3pt !important; }
      .planning-no-action { padding: 3pt 7pt !important; font-size: 6pt !important; }`;
  }

  // Inject all dynamic print CSS
  let dynStyle = document.getElementById('dynamic-print-style');
  if (!dynStyle) { dynStyle = document.createElement('style'); dynStyle.id = 'dynamic-print-style'; document.head.appendChild(dynStyle); }
  dynStyle.textContent = `@media print { ${cardPrintStyle} ${tablePrintStyle} ${planPrintStyle} }`;

  const html = `
  <div class="report">
    <button class="btn-print" onclick="savePDF('${name}')">ğŸ–¨ï¸ ×”×“×¤×¡×” / ×©××™×¨×” ×›-PDF (×œ×¨×•×—×‘ A4)</button>

    <div class="report-header">
      <div class="report-header-top">
        <div class="report-client-info">
          <h1>${name}</h1>
          <div class="report-client-id">×ª.×–. ${clientId}${phone ? ` &nbsp;Â·&nbsp; ${phone}` : ''}</div>
        </div>
        <div class="report-date-badge">
          <div class="date-label">×ª××¨×™×š ×”×¤×§×ª ×”×“×•×—</div>
          <div class="date-value">${today}</div>
        </div>
      </div>
    </div>

    <div class="summary-banner">
      <div class="summary-stat">
        <div class="stat-label">×¡×”"×› ××•×¦×¨×™×</div>
        <div class="stat-value">${savings.length}</div>
        <div class="stat-sub">×§×•×¤×•×ª / ×¤×•×œ×™×¡×•×ª / ×ª×™×§×™×</div>
      </div>
      <div class="summary-stat">
        <div class="stat-label">× ×–×™×œ</div>
        <div class="stat-value">${liquidSavings.length}</div>
        <div class="stat-sub">××•×¦×¨×™× × ×–×™×œ×™×</div>
      </div>
      <div class="summary-stat">
        <div class="stat-label">×œ× × ×–×™×œ</div>
        <div class="stat-value">${nonLiquidSavings.length}</div>
        <div class="stat-sub">××•×¦×¨×™× ×œ× × ×–×™×œ×™×</div>
      </div>
      <div class="summary-stat">
        <div class="stat-label">×¡×”"×› ×™×ª×¨×•×ª</div>
        <div class="stat-value">${totalBalance ? fmtCurrency(totalBalance) : '-'}</div>
        <div class="stat-sub">×¡×”"×› × ×›×¡×™× ××•×–× ×™×</div>
      </div>
      <div class="summary-stat">
        <div class="stat-label">×”×¤×§×“×” ×—×•×“×©×™×ª</div>
        <div class="stat-value">${totalMonthly ? fmtCurrency(totalMonthly) : '-'}</div>
        <div class="stat-sub">×¡×”"×› ×—×•×“×©×™</div>
      </div>
    </div>

    <div class="report-body">

      <!-- SAVINGS CARDS GRID -->
      <div class="report-section">
        <div class="report-section-title">
          <span class="dot" style="background:#3a7bd5;"></span>
          ×¤×™×¨×•×˜ ×§×•×¤×•×ª ×•×¤×•×œ×™×¡×•×ª
        </div>
        <div class="cards-grid" style="display:grid;grid-template-columns:repeat(${cardCols},1fr);gap:1rem;margin-top:0.8rem;" data-cols="${cardCols}">
          ${savings.map((s, i) => {
            const y = calcYieldData(s);
            const insOnly = ['×¨×™×¡×§','×‘×™×˜×•×— ×—×™×™×','×‘×™×˜×•×— ××©×›× ×ª×','××•×‘×“×Ÿ ×›×•×©×¨ ×¢×‘×•×“×”'].includes(s.productType);
            const yieldHtml = y
              ? `<div class="card-row"><span class="key">×ª×©×•××” ×›×•×œ×œ×ª</span><span class="val" style="color:${y.pct > 2 ? '#27ae60' : y.pct < 0 ? '#e74c3c' : '#f39c12'};font-weight:800;">${y.sign}${y.pct.toFixed(2)}% Â· ${y.sign}${fmtCurrency(Math.abs(y.gain))}</span></div>`
              : '';
            // 6-field mislaka projection block (no retirement age)
            const hasMislakaData = s.feeDeposit || s.feeAccumulation || s.projSavingsWith || s.projSavingsWithout || s.projPensionWith || s.projPensionWithout;
            return `
            <div class="saving-card${insOnly ? ' insurance-card' : ''}">
              <div class="saving-card-header">
                <div>
                  <div class="company">${s.company || '-'}</div>
                  <div class="policy">${s.productType || ''}${s.policyNum ? ' Â· ' + s.policyNum : ''}</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.3rem;">
                  <span class="saving-card-status ${statusClass(s.status)}">${s.status}</span>
                  ${!insOnly ? `<span class="liquidity-badge ${s.liquidity === '× ×–×™×œ' ? 'liquid' : 'not-liquid'}" style="font-size:0.62rem;">${s.liquidity === '× ×–×™×œ' ? 'ğŸ’§ × ×–×™×œ' : 'ğŸ”’ ×œ× × ×–×™×œ'}${s.liquidity === '×œ× × ×–×™×œ' && s.liquidityDate ? ' Â· ' + fmtDate(s.liquidityDate) : ''}</span>` : '<span style="font-size:0.6rem;color:rgba(248,215,214,0.8);">ğŸ›¡ï¸ ×›×™×¡×•×™ ×‘×œ×‘×“</span>'}
                </div>
              </div>
              <div class="saving-card-body">
                ${s.owner ? `<div class="card-row"><span class="key">×¢×œ ×©×</span><span class="val">${s.owner}</span></div>` : ''}
                ${!insOnly ? `<div class="card-row"><span class="key">×™×ª×¨×” × ×•×›×—×™×ª</span><span class="val" style="color:#27ae60;font-weight:800;">${s.balance ? fmtCurrency(s.balance) : '-'}</span></div>` : ''}
                ${yieldHtml}
                ${s.monthly ? `<div class="card-row"><span class="key">×”×¤×§×“×” ×—×•×“×©×™×ª</span><span class="val" style="color:#2980b9;">${fmtCurrency(s.monthly)}</span></div>` : ''}
                ${s.oneTime ? `<div class="card-row"><span class="key">×”×¤×§×“×” ×—×“-×¤×¢××™×ª</span><span class="val">${fmtCurrency(s.oneTime)}</span></div>` : ''}
                ${s.feeDeposit || s.feeAccumulation ? `<div class="card-row"><span class="key">×“××™ × ×™×”×•×œ</span><span class="val" style="font-size:0.78rem;">${s.feeDeposit ? '××”×¤×§×“×” ' + parseFloat(s.feeDeposit).toFixed(2) + '%' : ''}${s.feeDeposit && s.feeAccumulation ? ' Â· ' : ''}${s.feeAccumulation ? '××¦×‘×™×¨×” ' + parseFloat(s.feeAccumulation).toFixed(2) + '%' : ''}</span></div>` : ''}
                ${s.goal ? `<div class="card-row"><span class="key">××˜×¨×”</span><span class="val">${s.goal}</span></div>` : ''}
                ${s.balanceDate ? `<div class="card-row"><span class="key">×¢×“×›×•×Ÿ ×™×ª×¨×”</span><span class="val" style="color:#8899aa;font-size:0.78rem;">${fmtDate(s.balanceDate)}</span></div>` : ''}
                ${s.hasLoan ? `<div class="loan-block"><div class="loan-title">ğŸ’³ ×”×œ×•×•××” ×¤×¢×™×œ×”</div><div class="loan-grid"><div class="loan-item"><div class="k">×¡×›×•×</div><div class="v">${fmtCurrency(s.loanAmount)}</div></div><div class="loan-item"><div class="k">×¨×™×‘×™×ª</div><div class="v">${s.loanRate}%</div></div><div class="loan-item"><div class="k">×”×—×–×¨ ×—×•×“×©×™</div><div class="v">${fmtCurrency(s.loanMonthly)}</div></div></div></div>` : ''}
                ${hasMislakaData ? `
                <div class="loan-block" style="border-top-color:#c9a84c;background:rgba(201,168,76,0.04);">
                  <div class="loan-title" style="color:#8a6200;">ğŸ›ï¸ × ×ª×•× ×™ ×¤×¨×™×©×” ×××¡×œ×§×”</div>
                  <div class="loan-grid">
                    ${s.projSavingsWith    ? `<div class="loan-item"><div class="k">×—×™×¡×›×•×Ÿ ×¢× ×”×¤×§×“×•×ª</div><div class="v" style="color:#27ae60;">${fmtCurrency(s.projSavingsWith)}</div></div>` : ''}
                    ${s.projSavingsWithout ? `<div class="loan-item"><div class="k">×—×™×¡×›×•×Ÿ ×œ×œ× ×”×¤×§×“×•×ª</div><div class="v">${fmtCurrency(s.projSavingsWithout)}</div></div>` : ''}
                    ${s.projPensionWith    ? `<div class="loan-item"><div class="k">×§×¦×‘×” ×¢× ×”×¤×§×“×•×ª</div><div class="v" style="color:#2471a3;">${fmtCurrency(s.projPensionWith)}</div></div>` : ''}
                    ${s.projPensionWithout ? `<div class="loan-item"><div class="k">×§×¦×‘×” ×œ×œ× ×”×¤×§×“×•×ª</div><div class="v">${fmtCurrency(s.projPensionWithout)}</div></div>` : ''}
                    ${s.feeAccumulation   ? `<div class="loan-item"><div class="k">×“.× . ××¦×‘×™×¨×”</div><div class="v">${parseFloat(s.feeAccumulation).toFixed(2)}%</div></div>` : ''}
                    ${s.feeDeposit        ? `<div class="loan-item"><div class="k">×“.× . ××”×¤×§×“×”</div><div class="v">${parseFloat(s.feeDeposit).toFixed(2)}%</div></div>` : ''}
                  </div>
                </div>` : ''}
                ${s.recType && s.recType !== '' ? `
                <div class="rec-card-block ${s.recPriority || 'none'}">
                  <div class="rec-card-pill ${s.recPriority || 'none'}">${s.recPriority === 'high' ? 'ğŸ”´ ×“×—×•×£' : s.recPriority === 'mid' ? 'ğŸŸ¡ ×‘×™× ×•× ×™' : s.recPriority === 'low' ? 'ğŸŸ¢ × ××•×š' : 'ğŸ“‹'} ${s.recType}</div>
                  ${s.recNotes ? `<div class="rec-card-text">${s.recNotes}</div>` : ''}
                  ${s.recDate ? `<div class="rec-card-date">â± ×œ×‘×™×¦×•×¢ ×¢×“: ${fmtDate(s.recDate)}</div>` : ''}
                </div>` : ''}
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>

      <!-- TABLE SUMMARY -->
      <div class="report-section table-page-start" style="margin-top:1.5rem;">

        <!-- COMPACT FINANCIAL SUMMARY BAR -->
        <div class="fin-summary-bar" style="margin-bottom:0.7rem;">
          <div class="fsb-item">ğŸ’§ <strong>${liquidSavings.length}</strong> × ×–×™×œ Â· <span class="fsb-amt">${totalLiquidBalance ? fmtCurrency(totalLiquidBalance) : 'â‚ª0'}</span></div>
          <div class="fsb-sep"></div>
          <div class="fsb-item">ğŸ”’ <strong>${nonLiquidSavings.length}</strong> ×œ× × ×–×™×œ Â· <span class="fsb-amt">${totalNonLiquidBalance ? fmtCurrency(totalNonLiquidBalance) : 'â‚ª0'}</span></div>
          <div class="fsb-sep"></div>
          ${totalLoans ? `<div class="fsb-item">ğŸ’³ ×”×œ×•×•××•×ª: <span class="fsb-amt">${fmtCurrency(totalLoans)}</span>${totalLoanMonthly ? ' Â· ' + fmtCurrency(totalLoanMonthly) + '/×—' : ''}</div><div class="fsb-sep"></div>` : ''}
          <div class="fsb-item">ğŸ“Š ×¡×”"×›: <span class="fsb-amt">${fmtCurrency(totalBalance)}</span></div>
          ${totalMonthly ? `<div class="fsb-sep"></div><div class="fsb-item">ğŸ“… ×—×•×“×©×™: <span class="fsb-amt">${fmtCurrency(totalMonthly)}</span></div>` : ''}
        </div>

        <div class="report-section-title">
          <span class="dot"></span>
          ×¡×™×›×•× ×§×•×¤×•×ª, ×¤×•×œ×™×¡×•×ª ×•×ª×™×§×™ ×”×©×§×¢×•×ª
        </div>
        <div style="width:100%;">
          <table class="compact-table" style="width:100%;table-layout:fixed;">
            <colgroup>
              <col style="width:3%">
              <col style="width:12%">
              <col style="width:9%">
              <col style="width:9%">
              <col style="width:8%">
              <col style="width:6%">
              <col style="width:9%">
              <col style="width:9%">
              <col style="width:9%">
              <col style="width:7%">
              <col style="width:8%">
              <col style="width:11%">
            </colgroup>
            <thead>
              <tr>
                <th>#</th>
                <th>×¢×œ ×©×</th>
                <th>×—×‘×¨×”</th>
                <th>×¡×•×’ ××•×¦×¨</th>
                <th>×¤×•×œ×™×¡×”</th>
                <th>×¡×˜×˜×•×¡</th>
                <th>×™×ª×¨×”</th>
                <th>×ª×©×•××”</th>
                <th>×—. ×—×•×“×©×™×ª</th>
                <th>× ×–×™×œ×•×ª</th>
                <th>××˜×¨×”</th>
                <th>×”×œ×•×•××”</th>
              </tr>
            </thead>
            <tbody>
              ${savings.map((s, i) => `
              <tr>
                <td style="color:#8899aa;font-size:0.7rem;">${i + 1}</td>
                <td style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${s.owner || ''}">${s.owner || '-'}</td>
                <td style="font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${s.company || ''}">${s.company || '-'}</td>
                <td style="color:#556;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${s.productType || ''}">${s.productType || '-'}</td>
                <td style="font-family:monospace;font-size:0.7rem;color:#445;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${s.policyNum || '-'}</td>
                <td><span class="saving-card-status ${statusClass(s.status)}" style="font-size:0.6rem;padding:0.1rem 0.3rem;">${s.status}</span></td>
                <td style="font-weight:800;color:#27ae60;white-space:nowrap;">${s.balance ? fmtCurrency(s.balance) : '-'}</td>
                <td style="white-space:nowrap;">${(() => { const y = calcYieldData(s); if (!y) return '<span style="color:#ccc">-</span>'; const col = y.pct > 2 ? '#27ae60' : y.pct < 0 ? '#e74c3c' : '#f39c12'; return `<span style="font-weight:800;font-size:0.85rem;color:${col};">${y.sign}${y.pct.toFixed(1)}%</span><br><span style="font-size:0.6rem;color:${col};">${y.sign}${fmtCurrency(Math.abs(y.gain))}</span>`; })()}</td>
                <td style="color:#2980b9;">${s.monthly ? fmtCurrency(s.monthly) : '-'}</td>
                <td><span class="liquidity-badge ${s.liquidity === '× ×–×™×œ' ? 'liquid' : 'not-liquid'}" style="font-size:0.6rem;padding:0.1rem 0.35rem;">${s.liquidity === '× ×–×™×œ' ? 'ğŸ’§ × ×–×™×œ' : 'ğŸ”’ ×œ× × ×–×™×œ'}</span>${s.liquidity === '×œ× × ×–×™×œ' && s.liquidityDate ? `<div style="font-size:0.6rem;color:#888;margin-top:0.1rem;">${fmtDate(s.liquidityDate)}</div>` : ''}</td>
                <td style="color:#7a6a00;font-size:0.72rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${s.goal || ''}">${s.goal || '-'}</td>
                <td>${s.hasLoan ? `<span class="loan-flag">ğŸ’³ ${fmtCurrency(s.loanAmount)}</span><div style="font-size:0.62rem;color:#c0392b;margin-top:0.1rem;">×”×—×–×¨: ${fmtCurrency(s.loanMonthly)}/×—'</div>` : '<span style="color:#ccc;font-size:0.7rem;">-</span>'}</td>
              </tr>`).join('')}
            </tbody>
            <tfoot>
              <tr style="background:#f0f6ff;font-weight:700;border-top:2px solid #c3d6ed;">
                <td colspan="6" style="text-align:right;color:#8899aa;font-size:0.72rem;padding-left:0.5rem;">×¡×™×›×•× ×›×•×œ×œ â†“</td>
                <td style="color:#27ae60;font-size:0.88rem;font-weight:800;">${totalBalance ? fmtCurrency(totalBalance) : '-'}</td>
                <td style="color:#8899aa;font-size:0.7rem;">â€”</td>
                <td style="color:#2980b9;font-weight:700;">${totalMonthly ? fmtCurrency(totalMonthly) : '-'}</td>
                <td style="color:#8899aa;font-size:0.7rem;">â€”</td>
                <td style="color:#8899aa;font-size:0.7rem;">â€”</td>
                <td style="color:#c0392b;font-weight:700;">${totalLoanMonthly ? fmtCurrency(totalLoanMonthly) + '/×—\'' : 'â€”'}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>


      ${savings.some(s => s.hasLoan) ? `
      <!-- LOANS DETAIL TABLE -->
      <div class="report-section" style="margin-top:1.5rem;">
        <div class="report-section-title">
          <span class="dot" style="background:#e67e22;"></span>
          ×¤×™×¨×•×˜ ×”×œ×•×•××•×ª ×¤×¢×™×œ×•×ª
        </div>
        <div style="overflow-x:auto;">
          <table class="loans-table">
            <thead>
              <tr>
                <th>×§×•×¤×” / ×—×‘×¨×”</th>
                <th>×ª××¨×™×š</th>
                <th>×¡×›×•×</th>
                <th>×¨×™×‘×™×ª</th>
                <th>×ª×§×•×¤×”</th>
                <th>×¡×•×’ ×”×œ×•×•××”</th>
                <th>×¡×•×’ ×”×—×–×¨</th>
                <th>×”×—×–×¨ ×—×•×“×©×™</th>
                <th>××˜×¨×”</th>
              </tr>
            </thead>
            <tbody>
              ${savings.filter(s => s.hasLoan).map(s => `
              <tr>
                <td><strong>${s.company || '-'}</strong>${s.productType ? `<br><span style="font-size:0.7rem;color:#8899aa;">${s.productType}</span>` : ''}</td>
                <td>${s.loanDate ? fmtDate(s.loanDate) : '-'}</td>
                <td style="font-weight:700;color:var(--navy);">${s.loanAmount ? fmtCurrency(s.loanAmount) : '-'}</td>
                <td>${s.loanRate ? s.loanRate + '%' : '-'}</td>
                <td>${s.loanDuration ? s.loanDuration + ' ×—×•×“×©×™×' : '-'}</td>
                <td>${s.loanType || '-'}</td>
                <td>${s.loanRepay || '-'}</td>
                <td style="font-weight:800;color:#c0392b;">${s.loanMonthly ? fmtCurrency(s.loanMonthly) : '-'}</td>
                <td style="color:#8a6a1a;font-style:italic;">${s.loanGoal || '-'}</td>
              </tr>`).join('')}
              <tr class="loans-total-row">
                <td colspan="7" style="text-align:left;font-size:0.8rem;color:#8899aa;">* ×”×—×–×¨ ×—×•×“×©×™ ×›×•×œ×œ</td>
                <td style="font-weight:800;font-size:1rem;color:#c0392b;">${fmtCurrency(totalLoanMonthly)}</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>` : ''}

      ${(() => {
        const withRec = savings.filter(s => s.recType && s.recType !== '' && s.recType !== '×œ×”××©×™×š ×œ×œ× ×©×™× ×•×™');
        const noAction = savings.filter(s => !s.recType || s.recType === '' || s.recType === '×œ×”××©×™×š ×œ×œ× ×©×™× ×•×™');
        const high = withRec.filter(s => s.recPriority === 'high');
        const mid  = withRec.filter(s => s.recPriority === 'mid');
        const low  = withRec.filter(s => !s.recPriority || s.recPriority === 'low');
        if (withRec.length === 0) return `
          <div class="report-footer" style="margin-top:1rem;">
            <div class="footer-note">××¡××š ×–×” ×”×•×¤×§ ×œ×¦×¨×›×™ ××¢×§×‘ ×•××™× ×• ××”×•×•×” ×™×™×¢×•×¥ ×”×©×§×¢×•×ª ××• ×¤× ×¡×™×•× ×™</div>
            ${agent ? `<div class="agent-sig">×”×•×›×Ÿ ×¢"×™: ${agent}</div>` : ''}
          </div>`;

        const renderRow = (s, i, priority) => {
          const dot = priority === 'high' ? 'ğŸ”´' : priority === 'mid' ? 'ğŸŸ¡' : 'ğŸŸ¢';
          const isUrgent = s.recDate && new Date(s.recDate) < new Date(Date.now() + 30*24*60*60*1000);
          return `
          <div class="planning-row ${priority}">
            <div class="pr-num ${priority}">${i}</div>
            <div class="pr-content">
              <div class="pr-action">${dot} ${s.recType}</div>
              <div class="pr-who">${s.company || ''}${s.productType ? ' Â· ' + s.productType : ''}${s.owner ? ' Â· ' + s.owner : ''}</div>
              ${s.recNotes ? `<div class="pr-note">"${s.recNotes}"</div>` : ''}
            </div>
            <div class="pr-date ${isUrgent ? 'urgent' : ''}">${s.recDate ? 'â± ×¢×“ ' + fmtDate(s.recDate) : ''}</div>
          </div>`;
        };

        let counter = 1;
        let highHtml = '', midHtml = '', lowHtml = '';
        if (high.length) {
          highHtml = `<div class="planning-group">
            <div class="planning-group-title high">ğŸ”´ ×¢×“×™×¤×•×ª ×’×‘×•×”×” â€” ${high.length} ×¤×¢×•×œ×•×ª</div>
            ${high.map(s => renderRow(s, counter++, 'high')).join('')}
          </div>`;
        }
        if (mid.length) {
          midHtml = `<div class="planning-group">
            <div class="planning-group-title mid">ğŸŸ¡ ×¢×“×™×¤×•×ª ×‘×™× ×•× ×™×ª â€” ${mid.length} ×¤×¢×•×œ×•×ª</div>
            ${mid.map(s => renderRow(s, counter++, 'mid')).join('')}
          </div>`;
        }
        if (low.length) {
          lowHtml = `<div class="planning-group">
            <div class="planning-group-title low">ğŸŸ¢ ×¢×“×™×¤×•×ª × ××•×›×” â€” ${low.length} ×¤×¢×•×œ×•×ª</div>
            ${low.map(s => renderRow(s, counter++, 'low')).join('')}
          </div>`;
        }

        const noActionHtml = noAction.length ? `
          <div class="planning-group">
            <div class="planning-group-title done">âœ… ××•×¦×¨×™× ×œ×œ× ×©×™× ×•×™ × ×“×¨×©</div>
            <div class="planning-no-action">${noAction.map(s => `${s.company || ''}${s.owner ? ' (' + s.owner + ')' : ''}`).join(' Â· ')}</div>
          </div>` : '';

        return `
        <div class="planning-page" style="margin-top:2rem;">
          <div class="planning-header">
            <div>
              <h3>ğŸ“‹ ×ª×›× ×•×Ÿ ×¤×’×™×©×” ×”×‘××”</h3>
              <div class="ph-sub">×¤×¢×•×œ×•×ª ××•××œ×¦×•×ª ×œ×‘×™×¦×•×¢</div>
            </div>
            <div class="ph-stats">
              ${high.length ? `<div class="ph-stat"><div class="n" style="color:#e74c3c;">${high.length}</div><div class="l">×“×—×•×£</div></div>` : ''}
              ${mid.length  ? `<div class="ph-stat"><div class="n" style="color:#f39c12;">${mid.length}</div><div class="l">×‘×™× ×•× ×™</div></div>` : ''}
              ${low.length  ? `<div class="ph-stat"><div class="n" style="color:#27ae60;">${low.length}</div><div class="l">× ××•×š</div></div>` : ''}
              <div class="ph-stat"><div class="n">${withRec.length}</div><div class="l">×¡×”"×›</div></div>
            </div>
          </div>
          <div class="planning-body">
            ${highHtml}${midHtml}${lowHtml}${noActionHtml}
          </div>
          <div class="report-footer" style="margin-top:0.6rem;">
            <div class="footer-note">××¡××š ×–×” ×”×•×¤×§ ×œ×¦×¨×›×™ ××¢×§×‘ ×•××™× ×• ××”×•×•×” ×™×™×¢×•×¥ ×”×©×§×¢×•×ª ××• ×¤× ×¡×™×•× ×™</div>
            ${agent ? `<div class="agent-sig">×”×•×›×Ÿ ×¢"×™: ${agent}</div>` : ''}
          </div>
        </div>`;
      })()}
    </div>
  </div>
  `;

  document.getElementById('report-container').innerHTML = html;
  switchTab('report');
}

// CSV Fields definition
const CSV_CLIENT_FIELDS = ['client-name','client-id','client-phone','agent-name'];
const CSV_SAVING_FIELDS = ['owner','company','product-type','policy-num','status','goal','balance','balance-date','open-date','total-deposits','one-time','one-time-date','monthly','liquidity','liquidity-date','has-loan','loan-date','loan-amount','loan-rate','loan-duration','loan-type','loan-repay','loan-monthly','loan-goal','fee-deposit','fee-accumulation','retirement-age','proj-savings-with','proj-savings-without','proj-pension-with','proj-pension-without','rec-type','rec-priority','rec-date','rec-notes'];
const CSV_HEADERS = ['client-name','client-id','client-phone','agent-name',...CSV_SAVING_FIELDS];

function exportCSV() {
  const rows = [];
  // Header row
  rows.push(CSV_HEADERS.join(','));

  const clientVals = CSV_CLIENT_FIELDS.map(f => `"${(document.getElementById(f)?.value || '').replace(/"/g,'""')}"`);
  const savingBlocks = document.querySelectorAll('.saving-block');

  if (savingBlocks.length === 0) {
    rows.push(clientVals.join(',') + ',' + CSV_SAVING_FIELDS.map(() => '""').join(','));
  } else {
    savingBlocks.forEach((block, idx) => {
      const savingVals = CSV_SAVING_FIELDS.map(f => {
        if (f === 'has-loan') {
          return block.querySelector('[name="has-loan"]')?.checked ? '"1"' : '"0"';
        }
        const v = block.querySelector(`[name="${f}"]`)?.value || '';
        return `"${v.replace(/"/g,'""')}"`;
      });
      // Only include client info on first row
      const clientPart = idx === 0 ? clientVals : CSV_CLIENT_FIELDS.map(() => '""');
      rows.push([...clientPart, ...savingVals].join(','));
    });
  }

  const bom = '\uFEFF'; // UTF-8 BOM for Excel Hebrew support
  const blob = new Blob([bom + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const clientName = document.getElementById('client-name')?.value || 'client';
  a.href = url;
  a.download = `portfolio_${clientName}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function importCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result.replace(/^\uFEFF/, ''); // strip BOM
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) { alert('×§×•×‘×¥ CSV ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ'); return; }

    const headers = parseCSVRow(lines[0]);
    const rows = lines.slice(1).map(l => parseCSVRow(l));

    // Fill client info from first row
    const firstRow = Object.fromEntries(headers.map((h,i) => [h, rows[0]?.[i] || '']));
    CSV_CLIENT_FIELDS.forEach(f => {
      const el = document.getElementById(f);
      if (el && firstRow[f] !== undefined) el.value = firstRow[f];
    });

    // Clear existing savings
    document.getElementById('savings-list').innerHTML = '';
    savingCount = 0;

    // Add savings from each row
    rows.forEach(row => {
      const data = Object.fromEntries(headers.map((h,i) => [h, row[i] || '']));
      addSaving();
      const block = document.getElementById(`saving-${savingCount}`);
      CSV_SAVING_FIELDS.forEach(f => {
        if (f === 'has-loan') {
          const cb = block.querySelector('[name="has-loan"]');
          if (cb) { cb.checked = data[f] === '1'; if (cb.checked) document.getElementById(`loan-body-${savingCount}`)?.classList.add('open'); }
          return;
        }
        const el = block.querySelector(`[name="${f}"]`);
        if (el && data[f] !== undefined) el.value = data[f];
        // Trigger liquidity date toggle
        if (f === 'liquidity') { toggleLiqDate(el, `liq-date-wrap-${savingCount}`); }
      });
      // Recalculate yield after import
      calcYield(savingCount);
    });

    alert(`âœ… ×™×•×‘××• ${rows.length} ×§×•×¤×•×ª ×‘×”×¦×œ×—×”`);
    input.value = '';
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSVRow(row) {
  const result = [];
  let cur = '', inQuote = false;
  for (let i = 0; i < row.length; i++) {
    const ch = row[i];
    if (ch === '"') {
      if (inQuote && row[i+1] === '"') { cur += '"'; i++; }
      else inQuote = !inQuote;
    } else if (ch === ',' && !inQuote) {
      result.push(cur); cur = '';
    } else { cur += ch; }
  }
  result.push(cur);
  return result;
}

// Init with one empty saving
addSaving();

// =====================================================================
// MISLAKA IMPORT â€” ZIP / XML processing
// =====================================================================

let mislakaData = null; // holds parsed import data pending confirmation

// --- Load JSZip from CDN (lazy) ---
function loadJSZip() {
  return new Promise((resolve, reject) => {
    if (window.JSZip) { resolve(window.JSZip); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    s.onload  = () => resolve(window.JSZip);
    s.onerror = () => reject(new Error('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¡×¤×¨×™×™×ª ZIP â€” ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜'));
    document.head.appendChild(s);
  });
}

// --- Load SheetJS from CDN (lazy) ---
function loadSheetJS() {
  return new Promise((resolve, reject) => {
    if (window.XLSX) { resolve(window.XLSX); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    s.onload  = () => resolve(window.XLSX);
    s.onerror = () => reject(new Error('×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¡×¤×¨×™×™×ª XLS'));
    document.head.appendChild(s);
  });
}

// --- Parse XLS binary data â†’ array of sheet rows (objects keyed by column header) ---
function parseXlsData(arrayBuffer) {
  if (!window.XLSX) return [];
  try {
    const wb = XLSX.read(arrayBuffer, { type: 'array' });
    const allRows = [];
    wb.SheetNames.forEach(sheetName => {
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      rows.forEach(r => allRows.push(r));
    });
    return allRows;
  } catch (e) {
    return [];
  }
}

// --- Try to supplement parsed products with data from XLS rows ---
// Matches by policy number. Extracts management fees and retirement data.
function enrichProductsFromXls(products, xlsRows) {
  if (!xlsRows || !xlsRows.length) return;

  // Hebrew column name patterns for known fields
  const findCol = (row, patterns) => {
    for (const key of Object.keys(row)) {
      if (patterns.some(p => key.includes(p))) {
        const v = String(row[key] || '').trim();
        if (v && v !== '0') return v;
      }
    }
    return '';
  };

  products.forEach(prod => {
    if (!prod.policyNum) return;
    // Find XLS row(s) matching this policy number
    const matchRows = xlsRows.filter(r => {
      return Object.values(r).some(v => String(v).includes(prod.policyNum));
    });
    if (!matchRows.length) return;

    matchRows.forEach(row => {
      if (!prod.feeDeposit)
        prod.feeDeposit = findCol(row, ['×“××™ × ×™×”×•×œ ××”×¤×§×“×”', '×“.× . ××”×¤×§×“×”', '×¢××œ×ª ×”×¤×§×“×”']);
      if (!prod.feeAccumulation)
        prod.feeAccumulation = findCol(row, ['×“××™ × ×™×”×•×œ ××¦×‘×™×¨×”', '×“.× . ××¦×‘×™×¨×”', '×“××™ × ×™×”×•×œ ××—×™×¡×›×•×Ÿ']);
      if (!prod.retirementAge)
        prod.retirementAge = findCol(row, ['×’×™×œ ×¤×¨×™×©×”', '×’×™×œ ×™×¦×™××” ×œ×¤× ×¡×™×”']);
      if (!prod.projSavingsWith)
        prod.projSavingsWith = findCol(row, ['×—×™×¡×›×•×Ÿ ×¦×¤×•×™ ×¢× ×”×¤×§×“×•×ª', '×¦×‘×™×¨×” ×¦×¤×•×™×”']);
      if (!prod.projPensionWith)
        prod.projPensionWith = findCol(row, ['×§×¦×‘×” ×—×•×“×©×™×ª', '×§×¦×‘×” ×¦×¤×•×™×”', '×’××œ×” ×—×•×“×©×™×ª']);
      if (!prod.balance)
        prod.balance = findCol(row, ['×™×ª×¨×”', '×¦×‘×™×¨×”', '×—×™×¡×›×•×Ÿ ×¦×‘×•×¨']);
      if (!prod.monthly)
        prod.monthly = findCol(row, ['×”×¤×§×“×” ×—×•×“×©×™×ª', '×¡×”"×› ×”×¤×§×“×”']);
    });
  });
}

// --- Status bar helper ---
function setMislakaStatus(msg, type) {
  const el = document.getElementById('mislaka-status');
  if (!el) return;
  el.textContent = msg;
  el.className = 'mislaka-status-bar' + (type ? ' ' + type : '');
}

// --- Main entry: called when user selects a ZIP file ---
async function importMislaka(input) {
  const file = input.files[0];
  if (!file) return;
  input.value = '';

  setMislakaStatus('â³ ×˜×•×¢×Ÿ ×¡×¤×¨×™×™×ª ZIP...', 'loading');
  try {
    await loadJSZip();
  } catch (e) {
    setMislakaStatus('âŒ ' + e.message, 'error');
    return;
  }

  setMislakaStatus('â³ ×¤×•×ª×— ×§×•×‘×¥ ZIP...', 'loading');
  let zip;
  try {
    zip = await JSZip.loadAsync(file);
  } catch (e) {
    setMislakaStatus('âŒ ×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××ª ×”×§×•×‘×¥: ' + e.message, 'error');
    return;
  }

  // Collect XML and XLS entries
  const xmlEntries = [];
  const xlsEntries = [];
  zip.forEach((path, entry) => {
    if (entry.dir) return;
    const lp = path.toLowerCase();
    if (lp.endsWith('.xml')) xmlEntries.push(entry);
    else if (lp.endsWith('.xls') || lp.endsWith('.xlsx')) xlsEntries.push(entry);
  });

  if (!xmlEntries.length && !xlsEntries.length) {
    setMislakaStatus('âŒ ×œ× × ××¦××• ×§×‘×¦×™ XML ××• XLS ×‘××¨×›×™×‘', 'error');
    return;
  }

  setMislakaStatus('â³ ××¢×‘×“ ' + xmlEntries.length + ' ×§×‘×¦×™ XML...', 'loading');

  let clientInfo = null;
  const allProducts = [];

  for (const entry of xmlEntries) {
    try {
      const text = await entry.async('text');
      const parsed = parseMislakaXml(text);
      if (parsed.client && !clientInfo) clientInfo = parsed.client;
      allProducts.push(...parsed.products);
    } catch (e) {
      // skip bad file
    }
  }

  // Deduplicate by policyNum + company â€” keep the record with most data
  const productMap = new Map();
  allProducts.forEach(p => {
    const key = (p.policyNum || '') + '|' + (p.company || '');
    if (!key || key === '|') return;
    const score = (p.balance ? 2 : 0) + (p.monthly ? 1 : 0) + (p.tracks.length > 0 ? 1 : 0) + (p.netYield ? 1 : 0);
    const existing = productMap.get(key);
    if (!existing) {
      productMap.set(key, { product: p, score });
    } else if (score > existing.score) {
      productMap.set(key, { product: p, score });
    }
  });
  const products = Array.from(productMap.values()).map(e => e.product);

  // Parse XLS files and enrich products (if any XLS found)
  if (xlsEntries.length) {
    setMislakaStatus('â³ ××¢×‘×“ ' + xlsEntries.length + ' ×§×‘×¦×™ XLS...', 'loading');
    try {
      await loadSheetJS();
      const allXlsRows = [];
      for (const entry of xlsEntries) {
        try {
          const buf = await entry.async('arraybuffer');
          const rows = parseXlsData(buf);
          allXlsRows.push(...rows);
        } catch (e) { /* skip */ }
      }
      if (allXlsRows.length && products.length) {
        enrichProductsFromXls(products, allXlsRows);
      }
    } catch (e) {
      // SheetJS failed to load â€” continue without XLS data
    }
  }

  if (!products.length) {
    setMislakaStatus('âŒ ×œ× × ××¦××• ××•×¦×¨×™× ×¤× ×¡×™×•× ×™×™× ×‘×§×•×‘×¥', 'error');
    return;
  }

  const xlsNote = xlsEntries.length ? ' (×›×•×œ×œ ' + xlsEntries.length + ' XLS)' : '';
  mislakaData = { client: clientInfo, products };
  setMislakaStatus(
    'âœ… × ××¦××• ' + products.length + ' ××•×¦×¨×™×' +
    (clientInfo ? ' ×¢×‘×•×¨ ' + clientInfo.name : '') + xlsNote,
    'success'
  );
  showMislakaModal(mislakaData);
}

// --- XML helper: get text content of first matching tag ---
function xmlVal(el, tag) {
  if (!el) return '';
  const found = el.getElementsByTagName(tag)[0];
  if (!found) return '';
  return (found.textContent || '').trim();
}

// --- Convert YYYYMMDD â†’ YYYY-MM-DD for <input type="date"> ---
function xmlDateToInput(raw) {
  if (!raw || raw.length < 8) return '';
  return raw.substring(0, 4) + '-' + raw.substring(4, 6) + '-' + raw.substring(6, 8);
}

// --- Map SUG-MUTZAR code to Hebrew product type ---
function mapProductType(code, planName) {
  const plan = planName || '';
  // Insurance keywords take priority (check before code map)
  if (plan.includes('×¨×™×¡×§') || code === '8') return '×¨×™×¡×§';
  if (plan.includes('××•×‘×“×Ÿ ×›×•×©×¨'))            return '××•×‘×“×Ÿ ×›×•×©×¨ ×¢×‘×•×“×”';
  if (plan.includes('×‘×™×˜×•×— ××©×›× ×ª×'))          return '×‘×™×˜×•×— ××©×›× ×ª×';
  if (plan.includes('×‘×™×˜×•×— ×—×™×™×'))            return '×‘×™×˜×•×— ×—×™×™×';
  const map = {
    '1': '×§×•×¤×ª ×’××œ',
    '2': '×§×¨×Ÿ ×¤× ×¡×™×”',
    '3': '×§×¨×Ÿ ×”×©×ª×œ××•×ª',
    '4': '×§×¨×Ÿ ×”×©×ª×œ××•×ª',
    '5': '×‘×™×˜×•×— ×× ×”×œ×™×',
    '6': '×‘×™×˜×•×— ×× ×”×œ×™×',
    '7': '×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ',
    '9': '×’××œ ×œ×”×©×§×¢×”'
  };
  if (map[code]) return map[code];
  // Fallback: guess from plan name
  if (plan.includes('×¤× ×¡×™×”'))   return '×§×¨×Ÿ ×¤× ×¡×™×”';
  if (plan.includes('×”×©×ª×œ××•×ª')) return '×§×¨×Ÿ ×”×©×ª×œ××•×ª';
  if (plan.includes('×’××œ'))     return '×§×•×¤×ª ×’××œ';
  if (plan.includes('×× ×”×œ×™×'))  return '×‘×™×˜×•×— ×× ×”×œ×™×';
  if (plan.includes('×—×™×¡×›×•×Ÿ'))  return '×¤×•×œ×™×¡×ª ×—×™×¡×›×•×Ÿ';
  return '××—×¨';
}

// --- Detect whether product is insurance-only (no savings component) ---
function isInsuranceOnlyProduct(sugMutzar, planName) {
  const insuranceCodes = ['8'];
  const insuranceKeywords = ['×¨×™×¡×§', '××•×‘×“×Ÿ ×›×•×©×¨', '×‘×™×˜×•×— ××©×›× ×ª×', '×‘×™×˜×•×— ×—×™×™×'];
  if (insuranceCodes.includes(sugMutzar)) return true;
  return insuranceKeywords.some(kw => (planName || '').includes(kw));
}

// --- Map STATUS-POLISA code â†’ Hebrew status ---
// Israeli pension XML codes: 1=×¤×¢×™×œ, 2=×œ× ×¤×¢×™×œ/××•×§×¤×, 3=×‘×”×§××”, 4=×‘×•×˜×œ, 5=× ×¤×“×”
// 7 = ×§×¨×Ÿ ×”×©×ª×œ××•×ª ×‘×•×’×¨×ª (mature savings fund - still valid, eligible for withdrawal)
function mapStatus(code) {
  if (code === '1' || code === '2' || code === '7') return '×”×•×¤×§';
  if (code === '3') return '×‘×”×§××”';
  if (code === '4') return '×‘×•×˜×œ';
  if (code === '5') return '× ×¤×“×”';
  return '×”×•×¤×§';
}

// --- Strip excess leading zeros from Israeli ID (XML pads to 16 chars) ---
function cleanIsraeliId(raw) {
  if (!raw) return '';
  const digits = raw.replace(/\D/g, '');
  // Israeli ID is 9 digits; keep last 9 if longer
  return digits.length > 9 ? digits.slice(-9) : digits;
}

// --- Parse one XML file â†’ { client, products[] } ---
function parseMislakaXml(xmlText) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, 'application/xml');
  if (doc.getElementsByTagName('parsererror').length) return { client: null, products: [] };

  const root = doc.documentElement;

  // Company name from YeshutYatzran
  const yatzranEl = root.getElementsByTagName('YeshutYatzran')[0];
  const companyName = xmlVal(yatzranEl, 'SHEM-YATZRAN');

  const products = [];
  let clientInfo = null;

  const mutzarim = root.getElementsByTagName('Mutzar');
  for (let mi = 0; mi < mutzarim.length; mi++) {
    const mutzar = mutzarim[mi];

    const netunei   = mutzar.getElementsByTagName('NetuneiMutzar')[0];
    const sugMutzar = xmlVal(netunei, 'SUG-MUTZAR');
    const misparMislaka = xmlVal(netunei, 'MISPAR-MISLAKA');

    // Client info (from YeshutLakoach inside this Mutzar)
    const lakoach = mutzar.getElementsByTagName('YeshutLakoach')[0];
    if (lakoach && !clientInfo) {
      clientInfo = {
        name:  [xmlVal(lakoach, 'SHEM-PRATI'), xmlVal(lakoach, 'SHEM-MISHPACHA')].filter(Boolean).join(' '),
        id:    cleanIsraeliId(xmlVal(lakoach, 'MISPAR-ZIHUY-LAKOACH')),
        phone: xmlVal(lakoach, 'MISPAR-CELLULARI') || xmlVal(lakoach, 'MISPAR-TELEPHONE-KAVI') || ''
      };
    }

    const ownerName = lakoach
      ? [xmlVal(lakoach, 'SHEM-PRATI'), xmlVal(lakoach, 'SHEM-MISHPACHA')].filter(Boolean).join(' ')
      : '';
    const ownerId = lakoach ? cleanIsraeliId(xmlVal(lakoach, 'MISPAR-ZIHUY-LAKOACH')) : '';

    // Iterate policies
    const policies = mutzar.getElementsByTagName('HeshbonOPolisa');
    for (let pi = 0; pi < policies.length; pi++) {
      const policy = policies[pi];

      const policyNum  = xmlVal(policy, 'MISPAR-POLISA-O-HESHBON');
      const planName   = xmlVal(policy, 'SHEM-TOCHNIT');
      const statusCode = xmlVal(policy, 'STATUS-POLISA-O-CHESHBON');
      const openDate   = xmlDateToInput(xmlVal(policy, 'TAARICH-HITZTARFUT-RISHON'));
      const insuranceOnly = isInsuranceOnlyProduct(sugMutzar, planName);

      // â”€â”€ BALANCE: sum SCHUM-TZVIRA-BAMASLUL from all investment tracks (CURRENT balance) â”€â”€
      let balance = '';
      let trackBalanceSum = 0;

      // â”€â”€ INVESTMENT TRACKS â”€â”€
      const tracks = [];
      const trackList = policy.getElementsByTagName('PerutMasluleiHashkaa');
      for (let ti = 0; ti < trackList.length; ti++) {
        const t = trackList[ti];
        const tAmt = xmlVal(t, 'SCHUM-TZVIRA-BAMASLUL');
        const tAmtNum = parseFloat(tAmt) || 0;
        trackBalanceSum += tAmtNum;
        tracks.push({
          name:   xmlVal(t, 'SHEM-MASLUL-HASHKAA'),
          pct:    xmlVal(t, 'ACHUZ-HAFKADA-LEHASHKAA'),
          amount: tAmt,
          yld:    xmlVal(t, 'TSUA-NETO')
        });
      }
      if (trackBalanceSum > 0) balance = String(Math.round(trackBalanceSum));

      // â”€â”€ MANAGEMENT FEES (per-track first, then fallback to policy level) â€” max 2dp â”€â”€
      const fmtFee = (v) => { const n = parseFloat(v); return isNaN(n) || n === 0 ? '' : n.toFixed(2); };
      let feeDeposit = '';
      let feeAccumulation = '';
      for (let ti = 0; ti < trackList.length; ti++) {
        const t = trackList[ti];
        if (!feeDeposit)      feeDeposit     = fmtFee(xmlVal(t, 'SHEUR-DMEI-NIHUL-HAFKADA') || xmlVal(t, 'MEMOTZA-SHEUR-DMEI-NIHUL-HAFKADA'));
        if (!feeAccumulation) feeAccumulation = fmtFee(xmlVal(t, 'SHEUR-DMEI-NIHUL-TZVIRA') || xmlVal(t, 'SHEUR-DMEI-NIHUL-HISACHON'));
      }
      // Fallback: policy-level fee fields
      if (!feeDeposit)      feeDeposit     = fmtFee(xmlVal(policy, 'SHEUR-DMEI-NIHUL-HAFKADA') || xmlVal(netunei, 'SHEUR-DMEI-NIHUL-HAFKADA'));
      if (!feeAccumulation) feeAccumulation = fmtFee(xmlVal(policy, 'SHEUR-DMEI-NIHUL-TZVIRA') || xmlVal(netunei, 'SHEUR-DMEI-NIHUL-TZVIRA') || xmlVal(policy, 'SHEUR-DMEI-NIHUL-HISACHON'));

      // â”€â”€ CONTRIBUTIONS: split periodic vs one-time (SUG-HAFRASHA=3 â†’ one-time) â”€â”€
      let monthlyTotal = 0;
      let oneTimeTotal = 0;
      const hafrashotList = policy.getElementsByTagName('PerutHafrashotLePolisa');
      for (let hi = 0; hi < hafrashotList.length; hi++) {
        const hf = hafrashotList[hi];
        const sugHafrasha = xmlVal(hf, 'SUG-HAFRASHA');
        const amt = parseFloat(xmlVal(hf, 'SCHUM-HAFRASHA')) || 0;
        if (sugHafrasha === '3') {
          oneTimeTotal += amt;
        } else if (amt > 0) {
          monthlyTotal += amt;
        }
      }
      // Fallback for monthly: PirteiHafkadaAchrona
      if (!monthlyTotal) {
        const lastDep = policy.getElementsByTagName('PirteiHafkadaAchrona')[0];
        const lastDepAmt = parseFloat(xmlVal(lastDep, 'TOTAL-HAFKADA')) || 0;
        // Only use as monthly if not one-time (can't tell â€” treat as monthly)
        if (lastDepAmt) monthlyTotal = lastDepAmt;
      }
      // Fallback for monthly: annual salary / 12
      if (!monthlyTotal) {
        const annualSalary = parseFloat(xmlVal(policy.getElementsByTagName('PirteiHaasaka')[0], 'SACHAR-POLISA')) || 0;
        monthlyTotal = annualSalary / 12;
      }
      const monthly = monthlyTotal > 0 ? String(Math.round(monthlyTotal)) : '';
      const oneTime = oneTimeTotal > 0 ? String(Math.round(oneTimeTotal)) : '';

      // â”€â”€ RETIREMENT PROJECTIONS (from YitraLefiGilPrisha) â”€â”€
      const yitraEl = policy.getElementsByTagName('YitraLefiGilPrisha')[0];
      const retirementAge  = xmlVal(yitraEl, 'GIL-PRISHA');

      const projSavingsWithRaw    = xmlVal(yitraEl, 'TOTAL-CHISACHON-MITZTABER-TZAFUY');
      const projSavingsWithoutRaw = xmlVal(yitraEl, 'TZVIRAT-CHISACHON-CHAZUYA-LELO-PREMIYOT');
      const projSavingsWith    = projSavingsWithRaw    ? String(Math.round(parseFloat(projSavingsWithRaw)))    : '';
      const projSavingsWithout = projSavingsWithoutRaw ? String(Math.round(parseFloat(projSavingsWithoutRaw))) : '';

      const kupaEl = yitraEl ? yitraEl.getElementsByTagName('Kupa')[0] : null;
      const projPensionWithRaw    = xmlVal(kupaEl, 'KITZVAT-HODSHIT-TZFUYA');
      const projPensionWithoutRaw = xmlVal(kupaEl, 'KITZVAT-HODSHIT-TZFUYA-LELO-PREMIYOT') || xmlVal(kupaEl, 'SCHUM-KITZVAT-ZIKNA');
      const projPensionWith    = projPensionWithRaw    ? String(Math.round(parseFloat(projPensionWithRaw)))    : '';
      const projPensionWithout = projPensionWithoutRaw ? String(Math.round(parseFloat(projPensionWithoutRaw))) : '';

      // â”€â”€ LIQUIDITY: MOED-NEZILUT-TAGMULIM â€” if nearest date â‰¤ today â†’ × ×–×™×œ â”€â”€
      const today = new Date(); today.setHours(0,0,0,0);
      let liquidity = '×œ× × ×–×™×œ';
      let liquidityDate = '';
      const nezilutTags = policy.getElementsByTagName('MOED-NEZILUT-TAGMULIM');
      for (let ni = 0; ni < nezilutTags.length; ni++) {
        const raw = (nezilutTags[ni].textContent || '').trim();
        if (!raw || raw.length < 8) continue;
        const d = new Date(raw.substring(0,4) + '-' + raw.substring(4,6) + '-' + raw.substring(6,8));
        if (isNaN(d)) continue;
        if (d <= today) { liquidity = '× ×–×™×œ'; liquidityDate = xmlDateToInput(raw); break; }
        // Keep track of nearest future date
        if (!liquidityDate) liquidityDate = xmlDateToInput(raw);
        else {
          const prev = new Date(liquidityDate);
          if (d < prev) liquidityDate = xmlDateToInput(raw);
        }
      }
      // Insurance-only products are not savings â€” mark liquid by default (N/A)
      if (insuranceOnly) { liquidity = '× ×–×™×œ'; liquidityDate = ''; }

      // â”€â”€ DEPOSIT HISTORY (from PerutHafrashotLePolisa) â”€â”€
      const depositHistory = [];
      for (let hi = 0; hi < hafrashotList.length; hi++) {
        const hf = hafrashotList[hi];
        const sug = xmlVal(hf, 'SUG-HAFRASHA');
        const pct = xmlVal(hf, 'ACHUZ-HAFRASHA');
        const amt = xmlVal(hf, 'SCHUM-HAFRASHA');
        const depositor = xmlVal(hf, 'SUG-HAMAFKID');
        const date = xmlVal(hf, 'TAARICH-MADAD');
        if (sug || amt) depositHistory.push({ sug, pct, amt, depositor, date });
      }

      // â”€â”€ YIELD DATA â”€â”€
      const tsuaEl      = policy.getElementsByTagName('Tsua')[0];
      const netYield    = xmlVal(tsuaEl, 'SHEUR-TSUA-NETO');
      const profitLoss  = xmlVal(tsuaEl, 'REVACH-HEFSED-BENIKOI-HOZAHOT');
      const expectedYield = xmlVal(tsuaEl, 'SHEUR-TSUA-MOVTACHAT-MEYOADOT');

      // â”€â”€ LOAN â”€â”€
      const halvaaEl    = policy.getElementsByTagName('Halvaa')[0];
      const hasLoanCode = halvaaEl ? xmlVal(halvaaEl, 'YESH-HALVAA-BAMUTZAR') : '2';
      const hasLoan     = hasLoanCode === '1';
      const loanAmountRaw  = hasLoan ? xmlVal(halvaaEl, 'SCHUM-HALVAA') : '';
      const loanDateRaw    = hasLoan ? xmlVal(halvaaEl, 'TAARICH-KABALAT-HALVAA') : '';
      const loanRate       = hasLoan ? xmlVal(halvaaEl, 'RIBIT') : '';
      const loanPeriod     = hasLoan ? xmlVal(halvaaEl, 'TKUFAT-HALVAA') : '';
      const loanMonthlyRaw = hasLoan ? xmlVal(halvaaEl, 'SCHUM-HECHZER-TKUFATI') : '';

      // â”€â”€ INSURANCE COVERAGES â”€â”€
      const coverages = [];
      const kisuyList = policy.getElementsByTagName('ZihuiKisui');
      for (let ki = 0; ki < kisuyList.length; ki++) {
        const name = xmlVal(kisuyList[ki], 'SHEM-KISUI-YATZRAN');
        if (name) coverages.push(name);
      }

      products.push({
        owner:       ownerName + (ownerId ? ' Â· ' + ownerId : ''),
        company:     companyName,
        productType: mapProductType(sugMutzar, planName),
        policyNum,
        planName,
        status:      mapStatus(statusCode),
        openDate,
        balance,
        monthly,
        oneTime,
        hasLoan,
        loanAmount:  loanAmountRaw  ? String(Math.round(parseFloat(loanAmountRaw))) : '',
        loanDate:    xmlDateToInput(loanDateRaw),
        loanRate,
        loanPeriod,
        loanMonthly: loanMonthlyRaw ? String(Math.round(parseFloat(loanMonthlyRaw))) : '',
        tracks,
        netYield,
        profitLoss,
        expectedYield,
        retirementAge,
        projSavingsWith,
        projSavingsWithout,
        projPensionWith,
        projPensionWithout,
        feeDeposit,
        feeAccumulation,
        coverages,
        insuranceOnly,
        liquidity,
        liquidityDate,
        depositHistory,
        sugMutzar,
        misparMislaka
      });
    }
  }

  return { client: clientInfo, products };
}

// --- Render and open the preview modal ---
function showMislakaModal(data) {
  const { client, products } = data;

  // Update chip in header
  const chip = document.getElementById('mislaka-modal-client-chip');
  if (chip) chip.textContent = client ? client.name : '';

  const body = document.getElementById('mislaka-modal-body');
  let html = '';

  // Client summary banner
  if (client) {
    html += `
    <div class="mislaka-client-banner">
      <div>
        <div class="bcl">×œ×§×•×—</div>
        <div class="bcv">${client.name || 'â€”'}</div>
      </div>
      ${client.id ? `<div><div class="bcl">×ª×¢×•×“×ª ×–×”×•×ª</div><div class="bcv small">${client.id}</div></div>` : ''}
      ${client.phone ? `<div><div class="bcl">×˜×œ×¤×•×Ÿ</div><div class="bcv small">${client.phone}</div></div>` : ''}
      <div class="mislaka-count-badge">${products.length} ××•×¦×¨×™×</div>
    </div>`;
  }

  // Product cards
  products.forEach((p) => {
    const statusCls = p.status === '×”×•×¤×§' ? 'active' : p.status === '×‘×”×§××”' ? 'pending' : 'inactive';
    const fmt = (n) => n ? 'â‚ª' + Number(n).toLocaleString('he-IL') : '';

    // Retirement / fees section â€” 6 compact data points, always show if any data
    const hasMislakaData = p.projSavingsWith || p.projSavingsWithout || p.projPensionWith || p.projPensionWithout || p.feeDeposit || p.feeAccumulation;
    const retirementHtml = hasMislakaData ? `
    <div class="mp-retirement">
      <div class="mp-retirement-title">ğŸ›ï¸ × ×ª×•× ×™ ×¤×¨×™×©×” ×××¡×œ×§×”</div>
      <div class="mp-ret-grid" style="grid-template-columns:repeat(2,1fr);gap:0.5rem 1.2rem;">
        ${p.projSavingsWith    ? `<div class="mp-ret-item"><span class="rk">×—×™×¡×›×•×Ÿ ×¢× ×”×¤×§×“×•×ª</span><span class="rv green">${fmt(p.projSavingsWith)}</span></div>` : '<div class="mp-ret-item"></div>'}
        ${p.projPensionWith    ? `<div class="mp-ret-item"><span class="rk">×§×¦×‘×” ×¢× ×”×¤×§×“×•×ª</span><span class="rv blue">${fmt(p.projPensionWith)}</span></div>` : '<div class="mp-ret-item"></div>'}
        ${p.projSavingsWithout ? `<div class="mp-ret-item"><span class="rk">×—×™×¡×›×•×Ÿ ×œ×œ× ×”×¤×§×“×•×ª</span><span class="rv">${fmt(p.projSavingsWithout)}</span></div>` : '<div class="mp-ret-item"></div>'}
        ${p.projPensionWithout ? `<div class="mp-ret-item"><span class="rk">×§×¦×‘×” ×œ×œ× ×”×¤×§×“×•×ª</span><span class="rv">${fmt(p.projPensionWithout)}</span></div>` : '<div class="mp-ret-item"></div>'}
        ${p.feeAccumulation    ? `<div class="mp-ret-item"><span class="rk">×“.× . ××¦×‘×™×¨×”</span><span class="rv">${parseFloat(p.feeAccumulation).toFixed(2)}%</span></div>` : '<div class="mp-ret-item"></div>'}
        ${p.feeDeposit         ? `<div class="mp-ret-item"><span class="rk">×“.× . ××”×¤×§×“×”</span><span class="rv">${parseFloat(p.feeDeposit).toFixed(2)}%</span></div>` : '<div class="mp-ret-item"></div>'}
      </div>
    </div>` : '';

    html += `
    <div class="mp-card${p.insuranceOnly ? ' insurance-card' : ''}">
      <div class="mp-card-head">
        <div>
          <div class="mpc-company">${p.company || 'â€”'}</div>
          <div class="mpc-plan">${p.planName || p.productType || ''}</div>
          ${p.policyNum ? `<div class="mpc-policy">×¤×•×œ×™×¡×”: ${p.policyNum}</div>` : ''}
          ${p.insuranceOnly ? `<div class="insurance-only-badge">ğŸ›¡ï¸ ×‘×™×˜×•×— ×‘×œ×‘×“</div>` : ''}
        </div>
        <span class="mpc-status ${statusCls}">${p.status}</span>
      </div>
      <div class="mp-card-body">
        <div class="mp-fields">
          ${!p.insuranceOnly ? `
          <div class="mp-field">
            <span class="mpf-lbl">×™×ª×¨×” ×¦×‘×•×¨×”</span>
            <span class="mpf-val green">${p.balance ? 'â‚ª' + Number(p.balance).toLocaleString('he-IL') : 'â€”'}</span>
          </div>` : ''}
          <div class="mp-field">
            <span class="mpf-lbl">×”×¤×§×“×” ×—×•×“×©×™×ª</span>
            <span class="mpf-val blue">${p.monthly ? 'â‚ª' + Number(p.monthly).toLocaleString('he-IL') : 'â€”'}</span>
          </div>
          ${p.oneTime ? `
          <div class="mp-field">
            <span class="mpf-lbl">×”×¤×§×“×” ×—×“-×¤×¢××™×ª</span>
            <span class="mpf-val">${fmt(p.oneTime)}</span>
          </div>` : ''}
          <div class="mp-field">
            <span class="mpf-lbl">×¡×•×’ ××•×¦×¨</span>
            <span class="mpf-val">${p.productType}</span>
          </div>
          <div class="mp-field">
            <span class="mpf-lbl">×ª××¨×™×š ×¤×ª×™×—×”</span>
            <span class="mpf-val">${p.openDate ? fmtDate(p.openDate) : 'â€”'}</span>
          </div>
          ${p.owner ? `<div class="mp-field"><span class="mpf-lbl">×¢×œ ×©×</span><span class="mpf-val">${p.owner}</span></div>` : ''}
          ${p.netYield ? `<div class="mp-field"><span class="mpf-lbl">×ª×©×•××” × ×˜×•</span><span class="mpf-val blue">${p.netYield}%</span></div>` : ''}
          ${p.profitLoss ? `<div class="mp-field"><span class="mpf-lbl">×¨×•×•×— / ×”×¤×¡×“</span><span class="mpf-val">${Number(p.profitLoss).toLocaleString('he-IL')} â‚ª</span></div>` : ''}
          ${p.expectedYield ? `<div class="mp-field"><span class="mpf-lbl">×ª×©×•××” ×¦×¤×•×™×”</span><span class="mpf-val gold">${p.expectedYield}%</span></div>` : ''}
        </div>

        ${p.tracks.length ? `
        <div class="mp-tracks">
          <div class="mp-tracks-title">ğŸ“Š ××¡×œ×•×œ×™ ×”×©×§×¢×”</div>
          ${p.tracks.map(t => `
          <div class="mp-track-row">
            <span class="tr-name">${t.name || 'â€”'}</span>
            <span class="tr-pct">${t.pct ? t.pct + '%' : ''}</span>
            <span class="tr-amt">${t.amount ? 'â‚ª' + Number(t.amount).toLocaleString('he-IL') : ''}</span>
            <span class="tr-yld">${t.yld ? t.yld + '%' : ''}</span>
          </div>`).join('')}
        </div>` : ''}

        ${p.hasLoan ? `
        <div class="mp-loan">
          <div class="mp-loan-title">ğŸ’³ ×”×œ×•×•××” ×¤×¢×™×œ×”</div>
          ${p.loanAmount  ? `<div class="mp-loan-item"><span class="k">×¡×›×•×: </span><span class="v">â‚ª${Number(p.loanAmount).toLocaleString('he-IL')}</span></div>` : ''}
          ${p.loanRate    ? `<div class="mp-loan-item"><span class="k">×¨×™×‘×™×ª: </span><span class="v">${p.loanRate}%</span></div>` : ''}
          ${p.loanPeriod  ? `<div class="mp-loan-item"><span class="k">×ª×§×•×¤×”: </span><span class="v">${p.loanPeriod} ×—×•×“×©×™×</span></div>` : ''}
          ${p.loanMonthly ? `<div class="mp-loan-item"><span class="k">×”×—×–×¨ ×—×•×“×©×™: </span><span class="v red">â‚ª${Number(p.loanMonthly).toLocaleString('he-IL')}</span></div>` : ''}
          ${p.loanDate    ? `<div class="mp-loan-item"><span class="k">×ª××¨×™×š: </span><span class="v">${fmtDate(p.loanDate)}</span></div>` : ''}
        </div>` : ''}

        ${retirementHtml}

        ${p.coverages.length ? `
        <div class="mp-coverages">
          <strong>×›×™×¡×•×™×™× ×‘×™×˜×•×—×™×™×: </strong>${p.coverages.join(' Â· ')}
        </div>` : ''}
      </div>
    </div>`;
  });

  body.innerHTML = html;
  document.getElementById('mislaka-overlay').classList.add('open');
}

// --- Close modal ---
function closeMislakaModal() {
  document.getElementById('mislaka-overlay').classList.remove('open');
}

// --- Close when clicking outside the modal box ---
function handleOverlayClick(e) {
  if (e.target === document.getElementById('mislaka-overlay')) closeMislakaModal();
}

// --- ESC key closes modal ---
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeMislakaModal();
});

// --- Confirm import: populate form fields ---
function confirmMislakaImport() {
  if (!mislakaData) return;
  const { client, products } = mislakaData;

  // Fill client info
  if (client) {
    const n = document.getElementById('client-name');
    const i = document.getElementById('client-id');
    const p = document.getElementById('client-phone');
    if (n && client.name) n.value = client.name;
    if (i && client.id)   i.value = client.id;
    if (p && client.phone) p.value = client.phone;
  }

  // Clear savings list
  document.getElementById('savings-list').innerHTML = '';
  savingCount = 0;

  products.forEach(prod => {
    addSaving();
    const n = savingCount;
    const block = document.getElementById('saving-' + n);
    if (!block) return;

    const setVal = (name, val) => {
      if (!val && val !== 0) return;
      const el = block.querySelector('[name="' + name + '"]');
      if (el) el.value = val;
    };

    setVal('owner',      prod.owner);
    setVal('company',    prod.company);
    setVal('policy-num', prod.policyNum);
    setVal('open-date',  prod.openDate);
    setVal('balance',    prod.balance);
    setVal('monthly',    prod.monthly);
    // NOTE: 'goal' field is intentionally NOT set â€” manual entry only

    // One-time contribution
    if (prod.oneTime) {
      setVal('one-time', prod.oneTime);
      const otWrap = document.getElementById('one-time-date-wrap-' + n);
      if (otWrap) otWrap.style.display = 'flex';
    }

    // Product type select â€” match or fallback to ××—×¨
    const typeEl = block.querySelector('[name="product-type"]');
    if (typeEl) {
      const opts = Array.from(typeEl.options).map(o => o.value);
      typeEl.value = opts.includes(prod.productType) ? prod.productType : '××—×¨';
    }

    // Status select
    const statusEl = block.querySelector('[name="status"]');
    if (statusEl) statusEl.value = prod.status;

    // Loan
    if (prod.hasLoan && (prod.loanAmount || prod.loanRate)) {
      const cb = block.querySelector('[name="has-loan"]');
      if (cb) {
        cb.checked = true;
        const loanBody = document.getElementById('loan-body-' + n);
        if (loanBody) loanBody.classList.add('open');
      }
      setVal('loan-amount',   prod.loanAmount);
      setVal('loan-date',     prod.loanDate);
      setVal('loan-rate',     prod.loanRate);
      setVal('loan-duration', prod.loanPeriod);
      setVal('loan-monthly',  prod.loanMonthly);
    }

    // Management fees (now in main form row)
    setVal('fee-deposit',      prod.feeDeposit);
    setVal('fee-accumulation', prod.feeAccumulation);

    // Liquidity â€” from XML withdrawal date analysis
    if (prod.liquidity) {
      const liqEl = block.querySelector('[name="liquidity"]');
      if (liqEl) liqEl.value = prod.liquidity;
      if (prod.liquidity === '×œ× × ×–×™×œ' && prod.liquidityDate) {
        setVal('liquidity-date', prod.liquidityDate);
        const liqWrap = document.getElementById('liq-date-wrap-' + n);
        if (liqWrap) liqWrap.style.display = 'flex';
      }
    }

    // Pension projections â€” open section if any data present
    const hasPensionData = prod.projSavingsWith || prod.projSavingsWithout ||
                           prod.projPensionWith  || prod.projPensionWithout;
    if (hasPensionData) {
      setVal('retirement-age',      prod.retirementAge);
      setVal('proj-savings-with',   prod.projSavingsWith);
      setVal('proj-savings-without',prod.projSavingsWithout);
      setVal('proj-pension-with',   prod.projPensionWith);
      setVal('proj-pension-without',prod.projPensionWithout);
      const pensionHeader = document.getElementById('pension-header-' + n);
      const pensionBody   = document.getElementById('pension-body-'   + n);
      if (pensionHeader && pensionBody) {
        pensionHeader.classList.add('open');
        pensionBody.classList.add('open');
      }
    }

    // Deposit history â€” render table in deposits section
    if (prod.depositHistory && prod.depositHistory.length) {
      const contentEl = document.getElementById('deposits-content-' + n);
      if (contentEl) {
        contentEl.innerHTML = renderDepositsTable(prod.depositHistory);
      }
    }

    calcYield(n);
    calcLoanPayment(n);
  });

  closeMislakaModal();
  setMislakaStatus('âœ… ×™×•×‘××• ' + products.length + ' ××•×¦×¨×™× ×‘×”×¦×œ×—×” â€” × ×™×ª×Ÿ ×œ×¢×¨×™×›×” ×œ×¤× ×™ ×™×¦×™×¨×ª ×”×¡×™×›×•×', 'success');

  // Smooth scroll to savings
  const list = document.getElementById('savings-list');
  if (list) list.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
</body>
</html>
